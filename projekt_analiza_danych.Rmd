---
title: "Alcohol-Driven-Cognitive-Performance-Disruption-in-Univeristy-Students"
author: "Oskar Iwaszkiewicz, BartÅ‚omiej Duda, Kajetan Bernat, Olga Dawidowicz"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(naniar)
library(dplyr)
library(tidyverse)
library(finalfit)
library(mice)
library(ggmice)
library(VIM)
library(ggplot2)
library(kableExtra)
library(editrules)
library(factoextra)
library(plotly)
library(shiny)
```

## Wprowadzenie

```{r data wrangling}
dane <- read.csv("Stats survey.csv")
dane[dane == ""] <- NA
dane <- dane %>% select(-Timestamp)
dane <- dane %>% rename(sex = Your.Sex.,
                        grade_12 = Your.Matric..grade.12..Average..GPA..in...,
                        last_year = What.year.were.you.in.last.year..2023...,
                        faculty = What.faculty.does.your.degree.fall.under.,
                        grade_last_y = Your.2023.academic.year.average.GPA.in....Ignore.if.you.are.2024.1st.year.student.,
                        accomodation = Your.Accommodation.Status.Last.Year..2023.,
                        allowance = Monthly.Allowance.in.2023,
                        scholarship = Were.you.on.scholarship.bursary.in.2023.,
                        studying = Additional.amount.of.studying..in.hrs..per.week,
                        partying = How.often.do.you.go.out.partying.socialising.during.the.week..,
                        drinks = On.a.night.out..how.many.alcoholic.drinks.do.you.consume.,
                        classes_missed =  How.many.classes.do.you.miss.per.week.due.to.alcohol.reasons...i.e..being.hungover.or.too.tired..,
                        modules_failed = How.many.modules.have.you.failed.thus.far.into.your.studies.,
                        relationship = Are.you.currently.in.a.romantic.relationship.,
                        parents_alcohol_approval = Do.your.parents.approve.alcohol.consumption.,
                        relationship_w_parents =How.strong.is.your.relationship.with.your.parent.s.)

dane$sex <- ifelse(dane$sex == "Female", 0, ifelse(dane$sex == "Male", 1, dane$sex))
dane$sex <- factor(dane$sex, levels = c(0,1), labels = c("Kobieta", "MÄ™Å¼czyzna"))
dane$last_year <- ifelse(is.na(dane$last_year) & is.na(dane$grade_last_y), "12th class", dane$last_year)
dane$last_year <- factor(dane$last_year, levels = c("12th class", "1st Year", "2nd Year", "3rd Year", "4th Year", "Postgraduate"))
dane$faculty <- factor(dane$faculty, levels = unique(dane$faculty))
dane$accomodation <- ifelse(grepl("^Private.*", dane$accomodation), 1, ifelse(grepl("^Non.*", dane$accomodation), 0, dane$accomodation))
dane$accomodation <- factor(dane$accomodation, levels = c(0,1), labels = c("Nonprivate", "Private"))
dane$allowance <- factor(dane$allowance, levels = c("R 4001- R 5000", "R 5001 - R 6000", "R 6001 - R 7000", "R 7001 - R 8000", "R 8000+"))
dane$scholarship <- ifelse(dane$scholarship == "No", 0, ifelse(grepl("^Yes.*", dane$scholarship),1,dane$scholarship))
dane$scholarship <- factor(dane$scholarship, levels = c(0,1), labels = c("No", "Yes"))
dane$studying <- factor(dane$studying, levels = c("0", "1-3", "3-5", "5-8", "8+"))
dane$partying <- factor(dane$partying, levels = c("0", "1", "Only weekends", "2", "3", "4+"))
dane$drinks <- factor(dane$drinks, levels = c("0", "1-3", "3-5", "5-8", "8+"))
dane$classes_missed <- factor(dane$classes_missed, levels = c("0", "1", "2", "3",  "4+"))
dane$modules_failed <- factor(dane$modules_failed, levels = c("0", "1", "2", "3",  "4+"))
dane$relationship <- ifelse(dane$relationship == "No", 0, ifelse(dane$relationship == "Yes", 1, dane$relationship))
dane$relationship <- factor(dane$relationship, levels = c(0,1), labels = c("No", "Yes"))
dane$parents_alcohol_approval <- ifelse(dane$parents_alcohol_approval == "No", 0, ifelse(dane$parents_alcohol_approval == "Yes", 1, dane$parents_alcohol_approval))
dane$parents_alcohol_approval <- factor(dane$parents_alcohol_approval, levels = c(0,1), 
                                        labels = c("No", "Yes"))
dane$relationship_w_parents <- factor(dane$relationship_w_parents, levels = c("Distant", "Fair", "Close", "Very close"))
```

## Czyszczenie danych
PÅ‚eÄ‡: 0 - kobiety, 1 - mÄ™Å¼czyÅºni
Zakwaterowanie: 0 - publiczne, 1 - prywatne
DochÃ³d rozporzÄ…dalny: zamieniliÅ›my na dane kategoryczne: 0 - 4001 - 5000, 1- 5001 - 6000, 2 - 6001 - 7000, 3 - 7001 -8000, 4 - 8000+
Stypendium: 0 - brak, 1 - jest
Uczenie siÄ™: dane kategoryczne: 0 - 0, 1 - 1-3, 2 - 3-5, 3 - 5-8, 4 - 8+
picie: dane kategoryczne
opuszczone zajÄ™cia: dane kategoryczne: 0 - 0 , 1 - 1, 2-2 , 3 - 3, 4 - 4+
niezdane przedmioty: dane kategoryczne: 0 - 0 , 1 - 1, 2-2 , 3 - 3, 4 - 4+
status relacji: 0 - singiel, 1 - zajÄ™ty
czy rodzice akceptujÄ… picie alkoholu: 0 - nie, 1 - tak
relacja z rodzicami: dane kategorycznen
niezmienione zmienne: last_year, faculty, partying 

ZamieniliÅ›my NA w zmiennej last_year dla osÃ³b, ktÃ³re miaÅ‚y braki w last_year i grade_last_y na 12th class, poniewaÅ¼ ten pattern braku zmiany wynika z wypeÅ‚niania ankiety przez pierwszoklasiste

Osoby, ktÃ³re zaznaczyÅ‚y Postgraduate zaznaczaÅ‚y odpowiedzi zgodnie ze swoim ostatnim rokiem spÄ™dzonym na uczelni (nie byÅ‚ to 2023)

JeÅ¼eli pierwszoklasista posiada jakÄ…Å› ocenÄ™ z zeszÅ‚ego roku, to jest to bÅ‚Ä…d. 

CzÄ™Å›Ä‡ brakÃ³w danych zmiennej grade_last_y to braki danych strukturalne, czyli wynikajÄ… one z faktu, Å¼e dana zmienna nie dotyczy czÄ™Å›ci obserwacji (JeÅ¼eli ostatnia klasa to 12, to nie ma moÅ¼liwoÅ›ci posiadanie oceny za ostatni rok na studiach)


```{r wizualizacja brakÃ³w szukanie duplikatÃ³w i ich usuwanie sprawdzenie nieÅ›cisÅ‚oÅ›ci}
#sprawdzenie sensu danych 
RULE <- editset(c("grade_12 <= 100", "grade_12 >= 0", "grade_last_y <= 100", "grade_last_y >= 0"))
summary(violatedEdits(RULE, dane))
dane %>% 
  filter(!is.na(grade_last_y) & last_year == "12th class")

ggmice(dane, aes(last_year, grade_last_y)) + 
  geom_point()

vis_miss(dane, sort_miss = TRUE)
gg_miss_fct(dane, sex)
gg_miss_fct(dane, drinks)
md.pattern(dane, rotate.names = TRUE)
mcar_test(dane)

#sprawdzenie duplikatÃ³w
sum(duplicated(dane))
dane %>%
  filter(duplicated(.))
dane %>% 
  filter(grade_12 == 85 & grade_last_y == 73)
dane %>% 
  filter(grade_12 == 71 & is.na(grade_last_y))

#czy usunÄ…Ä‡ duplikaty?
dane <- dane %>% filter(!is.na(sex))
dane <- dane %>% filter(!is.na(faculty))
dane <- dane %>% filter(!is.na(last_year))

```

Usuwamy 2 wiersze, ktÃ³re sÄ… caÅ‚kowicie pozbawione wartoÅ›ci 
Usuwamy obserwacje, u ktÃ³rej nie posiadamy informacji na temat kierunku przez trudnoÅ›Ä‡ imputacji tej konkretnej zmiennej
Usuwamy obserwacje, u ktÃ³rej nie posiadamy informacji na temat klasy sprzed roku przez trudnoÅ›Ä‡ imputacji tej konkretnej zmiennej
Sprawdzenie sprzecznoÅ›ci

```{r imputacja danych}
dane_imp <- kNN(dane, variable = c("grade_last_y", "grade_12", "accomodation", "allowance", "scholarship", "studying", "classes_missed", "modules_failed"), k = 5)

dane$grade_last_y <- ifelse(dane$last_year != "12th class" & is.na(dane$grade_last_y), dane_imp$grade_last_y, dane$grade_last_y)
dane$grade_12 <- ifelse(is.na(dane$grade_12), dane_imp$grade_12, dane$grade_12)
dane$accomodation <- ifelse(is.na(dane$accomodation), dane_imp$accomodation, dane$accomodation)
dane$allowance <- ifelse(is.na(dane$allowance), dane_imp$allowance, dane$allowance)
dane$scholarship <- ifelse(is.na(dane$scholarship), dane_imp$scholarship, dane$scholarship)
dane$studying <- ifelse(is.na(dane$studying), dane_imp$studying, dane$studying)
dane$classes_missed <- ifelse(is.na(dane$classes_missed), dane_imp$classes_missed, dane$classes_missed)
dane$modules_failed <- ifelse(is.na(dane$modules_failed), dane_imp$modules_failed, dane$modules_failed)
#jakoÅ›Ä‡ imputcji
#stripplot(dane)
```

ZostaÅ‚a uÅ¼yta metoda KNN - k-najbliÅ¼szych sÄ…siadÃ³w
Opisz tutaj dlaczego k=5

```{r wizualizacja danych}
dane %>% 
  ggplot(aes(x=grade_12)) +
  geom_density(aes(fill=sex) , alpha = .25) +
  ggtitle("Oceny w 12 klasie") +
  xlab("Oceny") +
  ylab("CzÄ™stoÅ›Ä‡")

#geom_miss_point()
dane_clust <- dane %>%
  mutate(
    party_num = recode(partying,
                       "0"=0,"1"=1,"2"=2,"3"=3,"4+"=4,"Only weekends"=1.5),
    drinks_num = recode(drinks,
                        "0"=0,"1-3"=2,"3-5"=4,"5-8"=6,"8+"=9),
    grade = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  ) %>%
  select(studying, party_num, drinks_num, classes_missed, modules_failed, grade) %>%
  na.omit()

ui <- fluidPage(

  titlePanel("ðŸ”¥ Interaktywna Mapa ArchetypÃ³w StudentÃ³w"),

  sidebarLayout(
    sidebarPanel(
      sliderInput("clusters", "Liczba archetypÃ³w:", 
                  min = 2, max = 6, value = 4, step = 1),
      helpText("Archetypy mogÄ… byÄ‡ np.: Imprezowicz, Robot, PrzeciÄ™tniak, Ryzykant itd.")
    ),

    mainPanel(
      plotlyOutput("pcaPlot"),
      br(),
      uiOutput("archetypeDescriptions")
    )
  )
)

server <- function(input, output, session){

  # --- PCA ---
  pca <- prcomp(scale(dane_clust))

  clustered <- reactive({
    set.seed(123)
    km <- kmeans(scale(dane_clust), centers = input$clusters)
    df <- data.frame(pca$x[,1:2], cluster = factor(km$cluster))
    df
  })

  # --- OPIS ARCHETYPÃ“W ---
  output$archetypeDescriptions <- renderUI({

    desc <- c(
      "1" = "<b>Archetyp 1:</b> Imprezowicz â€“ duÅ¼o imprezuje, duÅ¼o pije, nisko siÄ™ uczy.",
      "2" = "<b>Archetyp 2:</b> Robot â€“ duÅ¼o siÄ™ uczy, maÅ‚o imprezuje, dobre oceny.",
      "3" = "<b>Archetyp 3:</b> PrzeciÄ™tniak â€“ Å›rednio we wszystkim.",
      "4" = "<b>Archetyp 4:</b> Ryzykant â€“ duÅ¼o imprezuje, ale oceny jeszcze trzymajÄ… siÄ™ Å›rednio.",
      "5" = "<b>Archetyp 5:</b> SamozagÅ‚ada 
      ,3000
      â€“ duÅ¼o imprez + maÅ‚o nauki + fatalne oceny.",
      "6" = "<b>Archetyp 6:</b> Ukryty Robot â€“ maÅ‚o imprezuje, oceny wysokie mimo maÅ‚ego nakÅ‚adu pracy."
    )

    HTML(paste(desc[1:input$clusters], collapse = "<br><br>"))
  })

  # --- PCA plot ---
  output$pcaPlot <- renderPlotly({

    df <- clustered()

    p <- ggplot(df, aes(PC1, PC2, color = cluster)) +
      geom_point(size = 4, alpha = 0.8) +
      scale_color_brewer(palette = "Set1") +
      labs(title = "Mapa ArchetypÃ³w StudentÃ³w (PCA + clustering)",
           x = "PC1", y = "PC2", color = "Archetyp") +
      theme_minimal()

    ggplotly(p)
  })
}

shinyApp(ui, server)

```

```{r wykres pytanie 7}
# 1. DANE
dane_plot <- dane %>%
  filter(!is.na(drinks), !is.na(grade_last_y), !is.na(sex)) %>%
  mutate(drinks = factor(drinks, levels = c("0", "1-3", "3-5", "5-8", "8+")))

# 2. AGREGACJA
srednie_df <- dane_plot %>%
  group_by(sex, drinks) %>%
  summarise(srednia_ocena = mean(grade_last_y), .groups = "drop")

# 3. KOLORYSTYKA "MODERN TECH"
my_colors <- c("Kobieta" = "#FF2D55",  # Apple Pink / Coral
               "MÄ™Å¼czyzna" = "#007AFF") # Apple Blue

# 4. WYKRES BAZOWY
p <- ggplot() +
  
  # A. SKRZYPCE (TÅO)
  geom_violin(data = dane_plot, 
              aes(x = drinks, y = grade_last_y, color = sex, fill = sex),
              alpha = 0.1,            # Bardzo delikatne tÅ‚o, Å¼eby nie przytÅ‚aczaÅ‚o
              trim = TRUE,            
              size = 0.3,             # Cieniutki kontur
              position = position_dodge(width = 0.7)) +
  
  # B. LINIE TRENDU
  geom_line(data = srednie_df, 
            aes(x = drinks, y = srednia_ocena, group = sex, color = sex),
            size = 1.2, 
            position = position_dodge(width = 0.7)) +
  
  # C. PUNKTY (NOÅšNIK INFORMACJI)
  # Tylko tutaj definiujemy 'text'
  geom_point(data = srednie_df, 
             aes(x = drinks, y = srednia_ocena, color = sex,
                 text = paste0("<b>", sex, "</b>",
                               "<br>Liczba drinkÃ³w: ", drinks,
                               "<br>Åšrednia ocena: ", round(srednia_ocena, 1))),
             size = 3.5, shape = 18, # Nieco wiÄ™ksze punkty dla czytelnoÅ›ci
             position = position_dodge(width = 0.7)) +
  
  # D. ESTETYKA
  scale_color_manual(values = my_colors) +
  scale_fill_manual(values = my_colors) +
  scale_y_continuous(limits = c(30, 100)) + 
  labs(x = "Liczba drinkÃ³w podczas wyjÅ›cia", y = "Åšrednia ocen (GPA)") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(), # Pionowe linie sÄ… zbÄ™dne przy kategoriach
    legend.position = "none"
  )

# 5. FINALNY PLOTLY + FIX DYMKÃ“W (NUCLEAR OPTION)
final_tech <- ggplotly(p, tooltip = "text") %>%
  layout(
    font = list(family = "Arial, sans-serif", size = 12, color = "#333333"),
    title = list(text = "<b>Czy pÅ‚eÄ‡ moderuje wpÅ‚yw alkoholu na wyniki?</b>", 
                 y = 0.96, x = 0.05, xanchor = "left", font = list(size = 18)),
    legend = list(
      orientation = "h", xanchor = "center", x = 0.5, y = -0.15,
      title = list(text = "<b>PÅ‚eÄ‡: </b>"),
      itemclick = "toggleothers",
      itemdoubleclick = "toggle"
    ),
    margin = list(t = 70, b = 80, l = 60, r = 20),
    hovermode = "closest"
  ) %>%
  config(displayModeBar = FALSE)

for (i in seq_along(final_tech$x$data)) {
  # Sprawdzamy, czy dana warstwa to punkty (mode zawiera 'markers')
  # JeÅ›li nie (czyli to linie lub skrzypce), ustawiamy hoverinfo na 'skip'
  if (!grepl("markers", final_tech$x$data[[i]]$mode)) {
    final_tech$x$data[[i]]$hoverinfo <- "skip"
  }
}

final_tech
```


```{r analiza opisowa}

```



