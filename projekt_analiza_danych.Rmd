---
title: "Alcohol Driven Cognitive Performance Disruption in Univeristy Students"
author: "Oskar Iwaszkiewicz, Bart≈Çomiej Duda, Kajetan Bernat, Olga Dawidowicz"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme:
      bootswatch: cosmo  
    toc: true
    toc_float: true      
---

```{r pakiety, include=FALSE}
library(naniar)
library(dplyr)
library(tidyverse)
library(finalfit)
library(mice)
library(ggmice)
library(VIM)
library(ggplot2)
library(kableExtra)
library(knitr)
library(validate)
library(factoextra)
library(plotly)
library(shiny)
library(prettydoc)
library(flexdashboard)
library(ggalluvial)
library(ggdist)
library(tidyquant)
library(modelsummary)
```

# Wprowadzenie
## Cel badania
Celem niniejszego projektu jest zbadanie wielowymiarowych zale≈ºno≈õci miƒôdzy spo≈ºyciem alkoholu, towarzyszƒÖcym mu stylem ≈ºycia a wynikami w nauce (GPA) oraz funkcjonowaniem poznawczym student√≥w uniwersyteckich. Problem ten jest istotny ze wzglƒôdu na powszechno≈õƒá kultury picia w ≈õrodowisku akademickim i jej potencjalnie negatywny wp≈Çyw na karierƒô edukacyjnƒÖ.
Analiza opiera siƒô na danych ankietowych obejmujƒÖcych zmienne demograficzne, ekonomiczne (stypendia, zakwaterowanie), spo≈Çeczne (relacje z rodzicami) oraz behawioralne (czƒôstotliwo≈õƒá imprezowania, absencja na zajƒôciach). W toku prac dane poddano czyszczeniu oraz imputacji, aby zapewniƒá rzetelno≈õƒá wnioskowania statystycznego.

## Pytania badawcze

W ramach analizy postawiono nastƒôpujƒÖce pytania badawcze, majƒÖce na celu zg≈Çƒôbienie mechanizm√≥w rzƒÖdzƒÖcych badanym zjawiskiem:

1. **Bezpo≈õredni wp≈Çyw alkoholu na wyniki:** Czy istnieje istotna statystycznie, ujemna korelacja miƒôdzy ilo≈õciƒÖ spo≈ºywanego alkoholu a ≈õredniƒÖ ocen (GPA)?
2. **Rola statusu ekonomicznego:** Czy wy≈ºszy doch√≥d rozporzƒÖdalny (`allowance`) stymuluje intensywniejsze ≈ºycie towarzyskie, po≈õrednio wp≈ÇywajƒÖc na obni≈ºenie wynik√≥w w nauce?
3. **≈örodowisko zamieszkania a kultura studencka:** Czy rodzaj zakwaterowania (sektor prywatny/dom rodzinny vs. akademiki) r√≥≈ºnicuje si≈Çƒô zwiƒÖzku miƒôdzy spo≈ºyciem alkoholu a liczbƒÖ opuszczonych zajƒôƒá?
4. **Psychospo≈Çeczne determinanty:** Czy jako≈õƒá relacji z rodzicami oraz ich aprobata dla spo≈ºywania alkoholu stanowiƒÖ istotne predyktory ryzykownych zachowa≈Ñ student√≥w?
5. **Efekt kompensacji:** Czy zwiƒôkszony nak≈Çad pracy w≈Çasnej (dodatkowe godziny nauki w tygodniu) jest w stanie zniwelowaƒá negatywny wp≈Çyw "imprezowego stylu ≈ºycia" na ≈õredniƒÖ ocen?
6. W jakim stopniu "imprezowy styl ≈ºycia" zwiƒôksza ryzyko niezdania przedmiot√≥w?
7. **R√≥≈ºnice miƒôdzyp≈Çciowe (Gender Gap):** Czy p≈Çeƒá studenta r√≥≈ºnicuje wzorce spo≈ºycia alkoholu oraz czy moderuje si≈Çƒô zwiƒÖzku miƒôdzy piciem a wynikami w nauce?


```{r data wrangling, include=FALSE}
dane <- read.csv("Stats survey.csv")
dane[dane == ""] <- NA
dane <- dane %>% select(-Timestamp)
dane <- dane %>% rename(sex = Your.Sex.,
                        grade_12 = Your.Matric..grade.12..Average..GPA..in...,
                        last_year = What.year.were.you.in.last.year..2023...,
                        faculty = What.faculty.does.your.degree.fall.under.,
                        grade_last_y = Your.2023.academic.year.average.GPA.in....Ignore.if.you.are.2024.1st.year.student.,
                        accomodation = Your.Accommodation.Status.Last.Year..2023.,
                        allowance = Monthly.Allowance.in.2023,
                        scholarship = Were.you.on.scholarship.bursary.in.2023.,
                        studying = Additional.amount.of.studying..in.hrs..per.week,
                        partying = How.often.do.you.go.out.partying.socialising.during.the.week..,
                        drinks = On.a.night.out..how.many.alcoholic.drinks.do.you.consume.,
                        classes_missed =  How.many.classes.do.you.miss.per.week.due.to.alcohol.reasons...i.e..being.hungover.or.too.tired..,
                        modules_failed = How.many.modules.have.you.failed.thus.far.into.your.studies.,
                        relationship = Are.you.currently.in.a.romantic.relationship.,
                        parents_alcohol_approval = Do.your.parents.approve.alcohol.consumption.,
                        relationship_w_parents =How.strong.is.your.relationship.with.your.parent.s.)

dane$sex <- ifelse(dane$sex == "Female", 0, ifelse(dane$sex == "Male", 1, dane$sex))
dane$sex <- factor(dane$sex, levels = c(0,1), labels = c("Kobieta", "Mƒô≈ºczyzna"))
dane$last_year <- ifelse(is.na(dane$last_year) & is.na(dane$grade_last_y), "12th class", dane$last_year)
dane$last_year <- factor(dane$last_year, levels = c("12th class", "1st Year", "2nd Year", "3rd Year", "4th Year", "Postgraduate"))
dane$faculty <- factor(dane$faculty, levels = unique(dane$faculty))
dane$accomodation <- ifelse(grepl("^Private.*", dane$accomodation), 1, ifelse(grepl("^Non.*", dane$accomodation), 0, dane$accomodation))
dane$accomodation <- factor(dane$accomodation, levels = c(0,1), labels = c("Nonprivate", "Private"))
dane$allowance <- factor(dane$allowance, levels = c("R 4001- R 5000", "R 5001 - R 6000", "R 6001 - R 7000", "R 7001 - R 8000", "R 8000+"))
dane$scholarship <- ifelse(dane$scholarship == "No", 0, ifelse(grepl("^Yes.*", dane$scholarship),1,dane$scholarship))
dane$scholarship <- factor(dane$scholarship, levels = c(0,1), labels = c("No", "Yes"))
dane$studying <- factor(dane$studying, levels = c("0", "1-3", "3-5", "5-8", "8+"))
dane$partying <- factor(dane$partying, levels = c("0", "1", "Only weekends", "2", "3", "4+"))
dane$drinks <- factor(dane$drinks, levels = c("0", "1-3", "3-5", "5-8", "8+"))
dane$classes_missed <- factor(dane$classes_missed, levels = c("0", "1", "2", "3",  "4+"))
dane$modules_failed <- factor(dane$modules_failed, levels = c("0", "1", "2", "3",  "4+"))
dane$relationship <- ifelse(dane$relationship == "No", 0, ifelse(dane$relationship == "Yes", 1, dane$relationship))
dane$relationship <- factor(dane$relationship, levels = c(0,1), labels = c("No", "Yes"))
dane$parents_alcohol_approval <- ifelse(dane$parents_alcohol_approval == "No", 0, ifelse(dane$parents_alcohol_approval == "Yes", 1, dane$parents_alcohol_approval))
dane$parents_alcohol_approval <- factor(dane$parents_alcohol_approval, levels = c(0,1), 
                                        labels = c("No", "Yes"))
dane$relationship_w_parents <- factor(dane$relationship_w_parents, levels = c("Distant", "Fair", "Close", "Very close"))
```

# Czyszczenie danych

W tym etapie surowe dane ankietowe zosta≈Çy poddane standaryzacji i transformacji, aby umo≈ºliwiƒá ich dalszƒÖ analizƒô statystycznƒÖ. Wykonano nastƒôpujƒÖce operacje:

* **Selekcja i nazewnictwo:** Usuniƒôto zbƒôdne kolumny (np. znaczniki czasowe) oraz nadano zmiennym intuicyjne nazwy (np. `sex`, `grade_12`, `drinks`), zastƒôpujƒÖc d≈Çugie pytania z kwestionariusza (Tabela 1).
* **Kodyfikacja zmiennych:**
    * Zmienne binarne (np. p≈Çeƒá, stypendium) przekodowano na format **0-1**.
    * Zmienne opisowe (np. przedzia≈Çy dochod√≥w, liczba drink√≥w) zamieniono na **skalƒô porzƒÖdkowƒÖ**, co pozwoli na zachowanie hierarchii danych w modelach korelacji.
* **Logika dla pierwszego roku:** Zidentyfikowano specyficznƒÖ grupƒô student√≥w pierwszego roku ("12th class"). Ich braki danych w kolumnie ocen z poprzedniego roku akademickiego (`grade_last_y`) nie sƒÖ b≈Çƒôdem, lecz wynikajƒÖ ze struktury badania (brak historii studiowania). Zosta≈Ço to uwzglƒôdnione w procesie czyszczenia.
* **Walidacja danych:** Zosta≈Çy r√≥wnie≈º sprawdzone ograniczenia, kt√≥re musia≈Çy obejmowaƒá zmienne i zosta≈Çy pod tym kƒÖtem sprawdzone.
* **Duplikaty:** W≈õr√≥d obserwacji by≈Çy r√≥wnie≈º duplikaty, jednak przez bardzo ma≈ÇƒÖ ich ilo≈õƒá (2) za≈Ço≈ºyli≈õmy, ≈ºe istnieje mo≈ºliwo≈õƒá na zaistnienie takiej sytuacji, wiƒôc nie zosta≈Çy one usuniƒôte.

```{r diagnostyka, include=FALSE}
#sprawdzenie sensu danych 
rules <- validator(
  Oceny_12_klasa = (grade_12 >= 0 & grade_12 <= 100) | is.na(grade_12),
  Oceny_zeszly_rok = (grade_last_y >= 0 & grade_last_y <= 100) | is.na(grade_last_y),
  Brak_oceny_12_klasa = if (last_year == "12th class") is.na(grade_last_y)
)
out <- confront(dane, rules)
summary(out)

#sprawdzenie NA w ostatniej zasadzie
dane %>% 
  filter(is.na(last_year))

#sprawdzenie duplikat√≥w
sum(duplicated(dane))
dane %>%
  filter(duplicated(.))
dane %>% 
  filter(grade_12 == 85 & grade_last_y == 73)
dane %>% 
  filter(grade_12 == 71 & is.na(grade_last_y))

#usuniƒôcie wierszy z brakami bez imputacji
dane <- dane %>% filter(!is.na(sex))
dane <- dane %>% filter(!is.na(faculty))
dane <- dane %>% filter(!is.na(last_year))

```


```{r tabela-zmiennych, echo=FALSE}

slownik <- data.frame(
  "Nazwa_Zmiennej" = c(
    "sex", "grade_12", "last_year", "faculty", "grade_last_y", 
    "accomodation", "allowance", "scholarship", "studying", 
    "partying", "drinks", "classes_missed", "modules_failed", 
    "relationship", "parents_alcohol_approval", "relationship_w_parents"
  ),
  "Opis_Pytania" = c(
    "P≈Çeƒá respondenta",
    "≈örednia ocen z 12 klasy (GPA)",
    "Rok studi√≥w w roku 2023",
    "Kierunek studi√≥w",
    "≈örednia ocen za rok akademicki 2023",
    "Status zakwaterowania (prywatne vs publiczne)",
    "Miesiƒôczny bud≈ºet",
    "Czy student posiada≈Ç stypendium",
    "Dodatkowe godziny nauki tygodniowo",
    "Czƒôstotliwo≈õƒá wychodzenia na imprezy",
    "Liczba drink√≥w spo≈ºywanych jednej nocy",
    "Liczba zajƒôƒá opuszczonych przez alkohol",
    "Liczba niezdanych przedmiot√≥w",
    "Czy student jest w zwiƒÖzku",
    "Czy rodzice akceptujƒÖ spo≈ºywanie alkoholu",
    "Relacja z rodzicami"
  )
)

# Generowanie ≈Çadnej tabeli
kable(slownik, 
      col.names = c("Nazwa zmiennej", "Opis zmiennej"),
      caption = "Tabela 1: S≈Çownik zmiennych") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = F, 
                position = "left") %>%
  column_spec(1, bold = TRUE, color = "#2c3e50") %>% # Wyr√≥≈ºnienie nazw zmiennych
  column_spec(2, width = "30em") # Poszerzenie opisu dla czytelno≈õci
```

# Analiza i diagnoza brak√≥w danych

```{r wizualizacja brak√≥w, echo=FALSE, warning=FALSE, fig.show='hold', out.width='50%', fig.height=6}
gg_miss_upset(dane, nsets = 5, nintersects = 10)


gg_miss_var(dane, show_pct = TRUE) + 
  labs(title = "Procentowy udzia≈Ç brak√≥w danych w zmiennych",
       y = "% BrakujƒÖcych warto≈õci",
       x = "Zmienne") +
  theme_minimal()

```

Przed przystƒÖpieniem do imputacji (uzupe≈Çniania) danych, przeprowadzono wizualnƒÖ inspekcjƒô brakujƒÖcych warto≈õci przy u≈ºyciu pakiet√≥w `naniar` i `ggmice`. Pozwoli≈Ço to na podjƒôcie kluczowych decyzji:

1. **Eliminacja rekord√≥w:** Usuniƒôto obserwacje posiadajƒÖce braki w kluczowych zmiennych strukturalnych: `sex` (p≈Çeƒá), `faculty` (wydzia≈Ç) oraz `last_year` (rok studi√≥w). Zmienne te definiujƒÖ profil studenta i sƒÖ trudne do wiarygodnego, sztucznego odtworzenia.
2. **Identyfikacja mechanizmu brak√≥w:** Potwierdzono, ≈ºe czƒô≈õƒá brak√≥w ma charakter strukturalny (wspomniani studenci pierwszego roku), co wyklucza prostƒÖ imputacjƒô ≈õredniƒÖ dla ca≈Çej populacji.

```{r imputacja danych, warning=FALSE, include=FALSE}
dane_imp <- kNN(dane, variable = c("grade_last_y", "grade_12", "accomodation", "allowance", "scholarship", "studying", "classes_missed", "modules_failed"), k = 5)

dane$grade_last_y <- as.numeric(ifelse(dane$last_year != "12th class" & is.na(dane$grade_last_y), dane_imp$grade_last_y, dane$grade_last_y))

dane <- dane %>%
  mutate(
    allowance = coalesce(allowance, dane_imp$allowance),
    scholarship = coalesce(scholarship, dane_imp$scholarship),
    accomodation = coalesce(accomodation, dane_imp$accomodation),
    grade_12 = coalesce(grade_12, dane_imp$grade_12),
    studying = coalesce(studying, dane_imp$studying),
    classes_missed = coalesce(classes_missed, dane_imp$classes_missed),
    modules_failed = coalesce(modules_failed, dane_imp$modules_failed)
  )

```

# Imputacja danych

Pozosta≈Çe braki danych (w zmiennych takich jak `allowance`, `scholarship` czy `grades`) uzupe≈Çniono, wykorzystujƒÖc algorytm **k-Nearest Neighbors (kNN)**. Metoda ta polega na znalezieniu dla ka≈ºdej niepe≈Çnej obserwacji grupy najbardziej podobnych do niej student√≥w ("sƒÖsiad√≥w") i uzupe≈Çnieniu braku na podstawie ich danych.

**Dob√≥r parametru $k=5$:**

Zdecydowano siƒô na ustawienie parametru liczby sƒÖsiad√≥w na $k=5$. Jest to optymalny kompromis:

* Warto≈õƒá ta jest wystarczajƒÖco du≈ºa, aby zminimalizowaƒá wp≈Çyw pojedynczych warto≈õci odstajƒÖcych (szumu w danych).
* Jednocze≈õnie jest wystarczajƒÖco ma≈Ça, aby zachowaƒá lokalnƒÖ strukturƒô danych i nie doprowadziƒá do nadmiernego "wyg≈Çadzenia" (u≈õrednienia) specyficznych cech student√≥w.

Dla zmiennej `grade_last_y` zastosowano podej≈õcie hybrydowe: imputacja zosta≈Ça przeprowadzona, a nastƒôpnie skorygowana logicznie dla student√≥w pierwszego roku, aby nie przypisywaƒá im sztucznych ocen z okresu, gdy nie studiowali.

Dodatkowo braki pozostawiono w zmiennych takich jak: `relationship`, `parents_alcohol_approval` oraz `relationship_w_parents` ze wzglƒôdu na trudno≈õƒá przewidzenia tak osobistych danych przez metody imputacji. 

```{r wizualizacja imputacji, echo=FALSE, fig.height=6, fig.show='hold', warning=FALSE, out.width='50%'}
#jako≈õƒá imputcji

ggplot(dane_imp, aes(x = allowance, y = grade_12, color = allowance_imp)) +
  geom_jitter(alpha = 0.6, width = 0.2, size = 2.5) +
  scale_color_manual(values = c("skyblue3", "firebrick1"), 
                     labels = c("Oryginalne", "Imputowane")) +
  labs(title = "Weryfikacja imputacji: Miesiƒôczny bud≈ºet (allowance)",
       subtitle = "Rozk≈Çad ocen wzglƒôdem bud≈ºetu z zaznaczeniem warto≈õci uzupe≈Çnionych",
       x = "Kategoria bud≈ºetu (allowance)",
       y = "≈örednia ocen (grade_12)",
       color = "Status danych") +
  theme_minimal()

ggplot(dane_imp, aes(x = accomodation, y = grade_12, color = accomodation_imp)) +
  geom_jitter(alpha = 0.6, width = 0.15, size = 2.5) +
  scale_color_manual(values = c("skyblue3", "firebrick1"), 
                     labels = c("Oryginalne", "Imputowane")) +
  labs(title = "Weryfikacja imputacji: Zakwaterowanie (accomodation)",
       subtitle = "Rozk≈Çad ocen wzglƒôdem rodzaju zakwaterowania",
       x = "Rodzaj zakwaterowania",
       y = "≈örednia ocen (grade_12)",
       color = "Status danych") +
  theme_minimal()

```

## Weryfikacja jako≈õci imputacji
W celu potwierdzenia poprawno≈õci dzia≈Çania algorytmu wygenerowano wykresy typu stripplot dla zmiennych `allowance` oraz `accommodation`. Zdecydowali≈õmy siƒô akurat na te zmienne ze wzglƒôdu na to, ≈ºe tylko one majƒÖ braki na poziomie co najmniej 5% (opr√≥cz brak√≥w strukturalnych w `grade_12`).

Wybrano zestawienie tych kategorii ze zmiennƒÖ `grade_12`, aby sprawdziƒá, czy warto≈õci uzupe≈Çnione (zaznaczone na czerwono) naturalnie wpisujƒÖ siƒô w rozk≈Çad danych oryginalnych. Brak wyra≈∫nych skupisk punkt√≥w imputowanych poza chmurƒÖ danych zaobserwowanych potwierdza, ≈ºe proces uzupe≈Çniania nie wprowadzi≈Ç zniekszta≈Çce≈Ñ do struktury zbioru.

# Wizualizacja danych

```{r shiny nie wiadomo co z tym zrobiƒá, eval=FALSE, include=FALSE}
dane_clust <- dane %>%
  mutate(
    party_num = recode(partying,
                       "0"=0,"1"=1,"2"=2,"3"=3,"4+"=4,"Only weekends"=1.5),
    drinks_num = recode(drinks,
                        "0"=0,"1-3"=2,"3-5"=4,"5-8"=6,"8+"=9),
    grade = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  ) %>%
  select(studying, party_num, drinks_num, classes_missed, modules_failed, grade) %>%
  na.omit()

ui <- fluidPage(

  titlePanel("üî• Interaktywna Mapa Archetyp√≥w Student√≥w"),

  sidebarLayout(
    sidebarPanel(
      sliderInput("clusters", "Liczba archetyp√≥w:", 
                  min = 2, max = 6, value = 4, step = 1),
      helpText("Archetypy mogƒÖ byƒá np.: Imprezowicz, Robot, Przeciƒôtniak, Ryzykant itd.")
    ),

    mainPanel(
      plotlyOutput("pcaPlot"),
      br(),
      uiOutput("archetypeDescriptions")
    )
  )
)

server <- function(input, output, session){

  # --- PCA ---
  pca <- prcomp(scale(dane_clust))

  clustered <- reactive({
    set.seed(123)
    km <- kmeans(scale(dane_clust), centers = input$clusters)
    df <- data.frame(pca$x[,1:2], cluster = factor(km$cluster))
    df
  })

  # --- OPIS ARCHETYP√ìW ---
  output$archetypeDescriptions <- renderUI({

    desc <- c(
      "1" = "<b>Archetyp 1:</b> Imprezowicz ‚Äì du≈ºo imprezuje, du≈ºo pije, nisko siƒô uczy.",
      "2" = "<b>Archetyp 2:</b> Robot ‚Äì du≈ºo siƒô uczy, ma≈Ço imprezuje, dobre oceny.",
      "3" = "<b>Archetyp 3:</b> Przeciƒôtniak ‚Äì ≈õrednio we wszystkim.",
      "4" = "<b>Archetyp 4:</b> Ryzykant ‚Äì du≈ºo imprezuje, ale oceny jeszcze trzymajƒÖ siƒô ≈õrednio.",
      "5" = "<b>Archetyp 5:</b> Samozag≈Çada 
      ,3000
      ‚Äì du≈ºo imprez + ma≈Ço nauki + fatalne oceny.",
      "6" = "<b>Archetyp 6:</b> Ukryty Robot ‚Äì ma≈Ço imprezuje, oceny wysokie mimo ma≈Çego nak≈Çadu pracy."
    )

    HTML(paste(desc[1:input$clusters], collapse = "<br><br>"))
  })

  # --- PCA plot ---
  output$pcaPlot <- renderPlotly({

    df <- clustered()

    p <- ggplot(df, aes(PC1, PC2, color = cluster)) +
      geom_point(size = 4, alpha = 0.8) +
      scale_color_brewer(palette = "Set1") +
      labs(title = "Mapa Archetyp√≥w Student√≥w (PCA + clustering)",
           x = "PC1", y = "PC2", color = "Archetyp") +
      theme_minimal()

    ggplotly(p)
  })
}

shinyApp(ui, server)

```

```{r zrobienie danych, include=FALSE}
dane_analiza <- dane %>%
  mutate(
    # Konwersja allowance na warto≈õƒá numerycznƒÖ (≈õrodek przedzia≈Çu)
    allow_val = case_when(
      allowance == "R 0 - R 1000" ~ 500,
      allowance == "R 1001 - R 2000" ~ 1500,
      allowance == "R 2001 - R 3000" ~ 2500,
      allowance == "R 3001 - R 4000" ~ 3500,
      allowance == "R 4001- R 5000" ~ 4500,
      allowance == "R 5001 - R 6000" ~ 5500,
      allowance == "R 6001 - R 7000" ~ 6500,
      allowance == "R 7001 - R 8000" ~ 7500,
      allowance == "R 8001+" ~ 9000,
      TRUE ~ 0
    ),
    # Grupowanie dochodu dla lepszej czytelno≈õci (Niski vs Wysoki)
    allow_group = ifelse(allow_val > 4000, "Wysoki bud≈ºet", "Niski bud≈ºet"),
    # Skala towarzyska (Partying + Drinks)
    social_index = recode(partying, "0"=0, "1"=1, "2"=2, "3"=3, "4+"=4, "Only weekends"=1.5) +
                   recode(drinks, "0"=0, "1-3"=2, "3-5"=4, "5-8"=6, "8+"=9),
    # Wynik akademicki (hybrydowy)
    grade_final = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  )
```

## Wp≈Çyw statusu ekonomicznego na styl ≈ºycia i wyniki

W tej sekcji postarali≈õmy siƒô odpowiedzieƒá na pytanie badawcze **czy wy≈ºszy doch√≥d rozporzƒÖdzalny stymuluje intensywniejsze ≈ºycie towarzyskie?**

```{r pytanie 2, echo=FALSE}
ggplot(dane_analiza, aes(x = social_index, y = grade_final)) +
  # Generowanie chmur gƒôsto≈õci
  geom_density_2d_filled(alpha = 0.8) +
  facet_wrap(~allow_group) + 
  
  # Ustawienie kolor√≥w i etykiet (uproszczone: tylko Niska i Wysoka)
  scale_fill_viridis_d(
    option = "plasma",
    labels = c("Niska", "", "", "", "", "", "", "", "","", "Wysoka")
  ) +
  
  labs(
    title = "Koncentracja student√≥w: Nauka vs Zabawa",
    subtitle = "Zale≈ºno≈õƒá miƒôdzy bud≈ºetem a stylem ≈ºycia.",
    x = "Indeks Towarzyski",
    y = "Wynik Akademicki (GPA %)",
    fill = "Gƒôsto≈õƒá wystƒôpowania:"
  ) +
  
  theme_minimal() +
  theme(
    # Przeniesienie legendy na d√≥≈Ç
    legend.position = "bottom",
    legend.box = "horizontal",
    # Pogrubienie tytu≈Çu i dodanie mu miejsca
    legend.title = element_text(face = "bold", size = 10),
    # KLUCZOWE: Dodanie marginesu na dole ca≈Çego wykresu, ≈ºeby legenda siƒô zmie≈õci≈Ça
    plot.margin = margin(t = 10, r = 10, b = 25, l = 10),
    # Odstƒôpy miƒôdzy panelami
    panel.spacing = unit(2, "lines"),
    strip.text = element_text(face = "bold")
  ) +
  
  # Konfiguracja wyglƒÖdu paska legendy
  guides(fill = guide_legend(
    nrow = 1, 
    # Wyd≈Çu≈ºenie paska (keywidth), ≈ºeby by≈Ço go lepiej widaƒá
    keywidth = unit(1.3, "cm"), 
    keyheight = unit(0.4, "cm"),
    # Ustawienie tytu≈Çu NAD paskiem (to rozwiƒÖzuje problem widoczno≈õci napisu)
    title.position = "top", 
    title.hjust = 0.5,
    label.position = "bottom"
  ))
```

### Metodologia i wska≈∫niki
Aby umo≈ºliwiƒá obiektywne por√≥wnanie grup, wprowadzono dwa parametry analityczne:

* **Podzia≈Ç bud≈ºetu:** Pr√≥bƒô badawczƒÖ podzielono na dwa segmenty wzglƒôdem miesiƒôcznego kieszonkowego:
    * **Ni≈ºszy bud≈ºet:** $\le 5000$ R.
    * **Wy≈ºszy bud≈ºet:** $> 5000$ R.
* **Indeks Towarzyski:** Stworzono zagregowany wska≈∫nik (skala 0‚Äì13 pkt), bƒôdƒÖcy sumƒÖ punkt√≥w za:
    * *Czƒôstotliwo≈õƒá imprezowania* (`partying`): 0‚Äì4 pkt (w tym warto≈õƒá 1.5 dla "Only weekends").
    * *Ilo≈õƒá spo≈ºywanego alkoholu* (`drinks`): 0‚Äì9 pkt.
    * Wska≈∫nik ten obrazuje **ca≈ÇkowitƒÖ intensywno≈õƒá stylu ≈ºycia** studenta.

### Interpretacja mapy gƒôsto≈õci
Wizualizacja wykorzystuje metodƒô estymacji gƒôsto≈õci jƒÖdrowej (**2D Kernel Density**). Skala kolorystyczna wskazuje na stopie≈Ñ koncentracji obserwacji w danej przestrzeni.

### Kluczowe wnioski
1.  **PieniƒÖdze jako stymulant:** W grupie z **wy≈ºszym bud≈ºetem** ‚Äûo≈õrodek ciƒô≈ºko≈õci‚Äù (≈º√≥≈Çty obszar) wyra≈∫nie przesuwa siƒô w prawƒÖ stronƒô osi X. Potwierdza to, ≈ºe wiƒôksze zasoby finansowe u≈ÇatwiajƒÖ dostƒôp do p≈Çatnych rozrywek i sprzyjajƒÖ **czƒôstszej konsumpcji alkoholu**.
2.  **Zwiƒôkszone ryzyko akademickie:** Choƒá w obu grupach najwy≈ºsze oceny korelujƒÖ z niskƒÖ intensywno≈õciƒÖ imprezowania, grupa zasobna wykazuje znacznie wiƒôksze **rozproszone w stronƒô wysokiej intensywno≈õci towarzyskiej**. Sugeruje to, ≈ºe nadmiar ≈õrodk√≥w sprzyja przedk≈Çadaniu zabawy nad obowiƒÖzki.
3.  **Dyscyplina ni≈ºszych dochod√≥w:** Studenci z ni≈ºszym bud≈ºetem wykazujƒÖ silniejszƒÖ koncentracjƒô w obszarze **umiarkowanego ≈ºycia towarzyskiego**, co przek≈Çada siƒô na statystycznie stabilniejsze i bardziej przewidywalne wyniki w nauce.

> **Podsumowanie:** Wy≈ºszy status ekonomiczny dzia≈Ça jako **katalizator ≈ºycia towarzyskiego**. ZwiƒôkszajƒÖc dostƒôpno≈õƒá kosztownych rozrywek, staje siƒô on po≈õrednim czynnikiem ryzyka dla wynik√≥w akademickich poprzez wyra≈∫nƒÖ zmianƒô priorytet√≥w czasowych studenta.

## ≈örodowisko zamieszkania a kultura studencka

```{r pytanie 3, echo=FALSE, message=FALSE}
# 1. Przygotowanie danych (konwersja na skale numeryczne)
dane_acc <- dane %>%
  mutate(
    # Uproszczenie nazw zakwaterowania
    acc_group = case_when(
      accomodation == "Nonprivate" ~ "Akademik",
      accomodation == "Private" ~ "Prywatne",
      TRUE ~ NA_character_
    ),
    # Konwersja drink√≥w na liczby
    drinks_num = case_when(
      drinks == "0" ~ 0,
      drinks == "1-3" ~ 2,
      drinks == "3-5" ~ 4,
      drinks == "5-8" ~ 6.5,
      drinks == "8+" ~ 10,
      TRUE ~ NA_real_
    ),
    # Konwersja opuszczonych zajƒôƒá na liczby
    missed_num = case_when(
      classes_missed == "0" ~ 0,
      classes_missed == "1" ~ 1,
      classes_missed == "2" ~ 2,
      classes_missed == "3" ~ 3,
      classes_missed == "4+" ~ 5,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(!is.na(acc_group), !is.na(drinks_num), !is.na(missed_num))

# 2. Tworzenie wykresu korelacji z podzia≈Çem na grupy
ggplot(dane_acc, aes(x = drinks_num, y = missed_num, color = acc_group)) +
  # Jitter zapobiega nak≈Çadaniu siƒô punkt√≥w na tych samych warto≈õciach
  geom_jitter(alpha = 0.5, size = 2.5, width = 0.3, height = 0.3) +
  # Linie trendu dla ka≈ºdej grupy
  geom_smooth(method = "lm", se = TRUE, size = 1.2) +
  # Facetowanie dla lepszego por√≥wnania
  facet_wrap(~acc_group) +
  scale_color_manual(values = c("Akademik" = "#e74c3c", "Prywatne" = "#3498db")) +
  labs(
    title = "Wp≈Çyw alkoholu na absencjƒô a miejsce zamieszkania",
    subtitle = "Por√≥wnanie nachylenia linii trendu: im bardziej stroma linia, tym silniejszy negatywny wp≈Çyw.",
    x = "Liczba drink√≥w podczas wyj≈õcia",
    y = "Liczba opuszczonych zajƒôƒá / tydzie≈Ñ",
    color = "Miejsce zamieszkania:"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none", # Ukrywamy legendƒô, bo facety sƒÖ podpisane
    strip.text = element_text(face = "bold", size = 12),
    plot.title = element_text(face = "bold")
  )
```


## Analiza efektu kompensacji

```{r pytanie 5, echo=FALSE, warning=FALSE}
# 1. Przygotowanie danych z nowymi nazwami zmiennych
dane_3d <- dane %>%
  mutate(
    # Konwersja godzin nauki (studying) na warto≈õci numeryczne
    study_num = case_when(
      studying == "0" ~ 0,
      studying == "1-3" ~ 1.5,
      studying == "3-5" ~ 4,
      studying == "5-8" ~ 6.5,
      studying == "8+" ~ 10,
      TRUE ~ NA_real_
    ),
    # Konwersja czƒôstotliwo≈õci imprez (partying) na liczby
    party_num = case_when(
      partying == "0" ~ 0,
      partying == "1" ~ 1,
      partying == "Only weekends" ~ 1.5,
      partying == "2" ~ 2,
      partying == "3" ~ 3,
      partying == "4+" ~ 5,
      TRUE ~ NA_real_
    ),
    # Ustalenie finalnego GPA (hybryda grade_last_y i grade_12)
    GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  ) %>%
  # Usuniƒôcie brak√≥w danych dla tych konkretnych wymiar√≥w
  filter(!is.na(study_num), !is.na(party_num), !is.na(GPA))

# 2. Tworzenie interaktywnego wykresu 3D
plot_ly(dane_3d, 
        x = ~party_num, 
        y = ~study_num, 
        z = ~GPA, 
        color = ~GPA, 
        colors = viridis::viridis(100), # Skala od fioletu (niskie) do ≈º√≥≈Çtego (wysokie)
        type = "scatter3d", 
        mode = "markers",
        marker = list(size = 5, opacity = 0.8, line = list(color = 'white', width = 0.5)),
        text = ~paste("Student ID:", row.names(dane_3d),
                      "<br>Nauka:", study_num, "h/tydz", 
                      "<br>Imprezy (index):", party_num, 
                      "<br>≈örednia:", GPA, "%")) %>%
  layout(
    scene = list(
      xaxis = list(title = "Intensywno≈õƒá imprez"),
      yaxis = list(title = "Dodatkowa nauka (h)"),
      zaxis = list(title = "Wynik akademicki (%)")
    ),
    title = "Tr√≥jwymiarowy model kompensacji: Nauka, Rozrywka i Wyniki"
  )
```





## R√≥≈ºnice miƒôdzyp≈Çciowe

```{r wykres pytanie 7, echo=FALSE, warning=FALSE}
# 1. DANE
dane_plot <- dane %>%
  filter(!is.na(drinks), !is.na(grade_last_y), !is.na(sex)) %>%
  mutate(drinks = factor(drinks, levels = c("0", "1-3", "3-5", "5-8", "8+")))

# 2. AGREGACJA
srednie_df <- dane_plot %>%
  group_by(sex, drinks) %>%
  summarise(srednia_ocena = mean(grade_last_y), .groups = "drop")

# 3. KOLORYSTYKA "MODERN TECH"
my_colors <- c("Kobieta" = "#FF2D55",  # Apple Pink / Coral
               "Mƒô≈ºczyzna" = "#007AFF") # Apple Blue

# 4. WYKRES BAZOWY
p <- ggplot() +
  
  # A. SKRZYPCE (T≈ÅO)
  geom_violin(data = dane_plot, 
              aes(x = drinks, y = grade_last_y, color = sex, fill = sex),
              alpha = 0.1,            # Bardzo delikatne t≈Ço, ≈ºeby nie przyt≈Çacza≈Ço
              trim = TRUE,            
              size = 0.3,             # Cieniutki kontur
              position = position_dodge(width = 0.7)) +
  
  # B. LINIE TRENDU
  geom_line(data = srednie_df, 
            aes(x = drinks, y = srednia_ocena, group = sex, color = sex),
            size = 1.2, 
            position = position_dodge(width = 0.7)) +
  
  # C. PUNKTY (NO≈öNIK INFORMACJI)
  # Tylko tutaj definiujemy 'text'
  geom_point(data = srednie_df, 
             aes(x = drinks, y = srednia_ocena, color = sex,
                 text = paste0("<b>", sex, "</b>",
                               "<br>Liczba drink√≥w: ", drinks,
                               "<br>≈örednia ocena: ", round(srednia_ocena, 1))),
             size = 3.5, shape = 18, # Nieco wiƒôksze punkty dla czytelno≈õci
             position = position_dodge(width = 0.7)) +
  
  # D. ESTETYKA
  scale_color_manual(values = my_colors) +
  scale_fill_manual(values = my_colors) +
  scale_y_continuous(limits = c(30, 100)) + 
  labs(x = "Liczba drink√≥w podczas wyj≈õcia", y = "≈örednia ocen (GPA)") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(), # Pionowe linie sƒÖ zbƒôdne przy kategoriach
    legend.position = "none"
  )

# 5. FINALNY PLOTLY + FIX DYMK√ìW (NUCLEAR OPTION)
final_tech <- ggplotly(p, tooltip = "text") %>%
  layout(
    font = list(family = "Arial, sans-serif", size = 12, color = "#333333"),
    title = list(text = "<b>Czy p≈Çeƒá moderuje wp≈Çyw alkoholu na wyniki?</b>", 
                 y = 0.96, x = 0.05, xanchor = "left", font = list(size = 18)),
    legend = list(
      orientation = "h", xanchor = "center", x = 0.5, y = -0.15,
      title = list(text = "<b>P≈Çeƒá: </b>"),
      itemclick = "toggleothers",
      itemdoubleclick = "toggle"
    ),
    margin = list(t = 70, b = 80, l = 60, r = 20),
    hovermode = "closest"
  ) %>%
  config(displayModeBar = FALSE)

for (i in seq_along(final_tech$x$data)) {
  # Sprawdzamy, czy dana warstwa to punkty (mode zawiera 'markers')
  # Je≈õli nie (czyli to linie lub skrzypce), ustawiamy hoverinfo na 'skip'
  if (!grepl("markers", final_tech$x$data[[i]]$mode)) {
    final_tech$x$data[[i]]$hoverinfo <- "skip"
  }
}

final_tech
```

# Analiza opisowa

```{r analiza opisowa rozklad ocen, echo=FALSE, message=FALSE, warning=FALSE}
# 1. Charakterystyka akademicka (GPA)
# Tworzymy zmiennƒÖ hybrydowƒÖ GPA dla pe≈Çniejszego obrazu
dane_desc <- dane %>%
  mutate(GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y))

# Statystyki opisowe ocen
stats_gpa <- dane_desc %>%
  summarise(
    N = n(),
    ≈örednia = round(mean(GPA, na.rm = TRUE), 2),
    Mediana = median(GPA, na.rm = TRUE),
    Odchylenie = round(sd(GPA, na.rm = TRUE), 2),
    Minimum = min(GPA, na.rm = TRUE),
    Maksimum = max(GPA, na.rm = TRUE)
  )

# 2. Wykres rozk≈Çadu ocen
plot_gpa <- ggplot(dane_desc, aes(x = GPA)) +
  geom_histogram(binwidth = 5, fill = "#3498db", color = "white", alpha = 0.8) +
  geom_vline(xintercept = mean(dane_desc$GPA, na.rm = TRUE), linetype = "dashed", color = "red", size = 1) +
  labs(title = "Rozk≈Çad ocen student√≥w (GPA %)", 
       subtitle = "Czerwona linia oznacza ≈õredniƒÖ",
       x = "Wynik (%)", y = "Liczba student√≥w") +
  theme_minimal()

# 3. Profil stylu ≈ºycia (Studying vs Partying)
# Przygotowanie danych do wykresu s≈Çupkowego

# Wy≈õwietlanie wynik√≥w
plot_gpa
kable(stats_gpa, caption = "Statystyki opisowe wynik√≥w akademickich (GPA)")




```

```{r rozklad ocen wzgledem plci, echo=FALSE}
# Przygotowanie danych
dane_rain <- dane %>%
  mutate(GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y)) %>%
  filter(!is.na(sex), !is.na(GPA))

# Wykres
ggplot(dane_rain, aes(x = sex, y = GPA, fill = sex)) +
  # 1. "Chmura" - Gƒôsto≈õƒá
  stat_halfeye(
    adjust = .5, width = .6, .width = 0, justification = -.3, point_colour = NA
  ) +
  # 2. "Pude≈Çko" - Boxplot
  geom_boxplot(
    width = .15, outlier.shape = NA, alpha = 0.5
  ) +
  # 3. "Deszcz" - Surowe dane
  geom_point(
    aes(color = sex),
    position = position_jitter(width = .15), size = .5, alpha = .3
  ) +
  scale_fill_tq() +
  scale_color_tq() +
  labs(
    title = "Rozk≈Çad ocen wzglƒôdem p≈Çci",
    x = "P≈Çeƒá", y = "Wynik akademicki (%)"
  ) +
  coord_flip() + # Obr√≥cenie dla lepszego efektu "chmury"
  theme_tq() +
  theme(legend.position = "none")
```

```{r analiza opisowa wedlug stypendium, echo=FALSE}
# Selekcja kluczowych zmiennych do tabeli
# Przygotowanie danych
dane_tab <- dane %>%
  mutate(GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y)) %>%
  select(`≈örednia ocen` = GPA, 
         `Stypendium` = scholarship, 
         `P≈Çeƒá` = sex, 
         `Nauka (h)` = studying, 
         `Imprezy` = partying)

# Tworzenie profesjonalnej tabeli opisowej
datasummary_balance(~Stypendium, 
                   data = dane_tab,
                   title = "Charakterystyka grup wzglƒôdem statusu stypendialnego",
                   dinm = FALSE) # Wy≈ÇƒÖcza r√≥≈ºnicƒô ≈õrednich dla uproszczenia


```


# Analiza korelacji

## Wp≈Çyw alkoholu na wyniki w nauce

```{r analiza korelacji pytanie 1, echo=FALSE, message=FALSE}

# 1. Przygotowanie danych
dane_kor <- dane %>%
  mutate(
    # Konwersja drink√≥w na warto≈õci numeryczne (≈õrodki przedzia≈Ç√≥w)
    drinks_num = case_when(
      drinks == "0" ~ 0,
      drinks == "1-3" ~ 2,
      drinks == "3-5" ~ 4,
      drinks == "5-8" ~ 6.5,
      drinks == "8+" ~ 10,
      TRUE ~ NA_real_
    ),
    # Hybrydowe GPA
    GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  ) %>%
  filter(!is.na(drinks_num), !is.na(GPA))

# 2. Obliczenie korelacji Spearmana
test_kor <- cor.test(dane_kor$drinks_num, dane_kor$GPA, method = "spearman", exact = FALSE)

# 3. Wizualizacja korelacji
ggplot(dane_kor, aes(x = drinks_num, y = GPA)) +
  geom_jitter(alpha = 0.4, color = "#2980b9", width = 0.3) +
  geom_smooth(method = "lm", color = "#c0392b", fill = "#e74c3c", alpha = 0.2) +
  labs(
    title = "Korelacja miƒôdzy spo≈ºyciem alkoholu a wynikami w nauce",
    subtitle = paste0("Wsp√≥≈Çczynnik korelacji rho: ", round(test_kor$estimate, 3), 
                      " | p-value: ", format.pval(test_kor$p.value, digits = 3)),
    x = "Przeciƒôtna liczba drink√≥w podczas wyj≈õcia",
    y = "≈örednia ocen (GPA %)"
  ) +
  theme_minimal()

```

W celu sprawdzenia zale≈ºno≈õci miƒôdzy ilo≈õciƒÖ spo≈ºywanego alkoholu a ≈õredniƒÖ ocen (GPA), przeprowadzono analizƒô korelacji rangowej Spearmana.

### Wyniki analizy
* **Wsp√≥≈Çczynnik korelacji ($\rho$):** `-0.086`
* **Poziom istotno≈õci ($p$):** `0.087`

**Interpretacja statystyczna:**
Analiza wykaza≈Ça bardzo s≈ÇabƒÖ, ujemnƒÖ tendencjƒô, jednak zale≈ºno≈õƒá ta **nie osiƒÖgnƒô≈Ça przyjƒôtego progu istotno≈õci statystycznej ($p < 0.05$)**. 

### Wnioski
1. **Brak istotno≈õci:** Poniewa≈º warto≈õƒá $p$ (0.087) jest wy≈ºsza ni≈º 0.05, nie mamy statystycznych podstaw, aby jednoznacznie stwierdziƒá, ≈ºe konsumpcja alkoholu bezpo≈õrednio obni≈ºa oceny w badanej populacji. Istnieje blisko 9% prawdopodobie≈Ñstwa, ≈ºe zaobserwowany trend jest jedynie wynikiem przypadku.
2. **Si≈Ça zwiƒÖzku:** Wsp√≥≈Çczynnik $\rho = -0.086$ wskazuje na korelacjƒô ≈õladowƒÖ. Sugeruje to, ≈ºe w badanej grupie studenci mogƒÖ skutecznie oddzielaƒá ≈ºycie towarzyskie od wynik√≥w w nauce lub stosowaƒá mechanizmy kompensacyjne (np. intensywniejszƒÖ naukƒô w dni bez imprez).
3. **Z≈Ço≈ºono≈õƒá zjawiska:** Wynik ten sugeruje, ≈ºe alkohol mo≈ºe wp≈Çywaƒá na wyniki jedynie po≈õrednio (np. poprzez absencjƒô na zajƒôciach), a nie jako bezpo≈õredni czynnik determinujƒÖcy spadek GPA.

> **Podsumowanie:** Hipoteza o bezpo≈õrednim, istotnym negatywnym wp≈Çywie alkoholu na ≈õredniƒÖ ocen **nie znalaz≈Ça potwierdzenia** w zebranych danych.

# Model logitowy 

```{r model do pytania 6, echo=FALSE, message=FALSE, warning=FALSE}

dane_model <- dane %>%
  mutate(
    # Tworzymy zmiennƒÖ binarnƒÖ: Czy obla≈Ç cokolwiek? (1 = Tak, 0 = Nie)
    failed_any = ifelse(as.numeric(modules_failed) > 1, 1, 0),
    
    # Konwersja czynnik√≥w na skale numeryczne
    party_num = case_when(
      partying == "0" ~ 0,
      partying == "1" ~ 1,
      partying == "Only weekends" ~ 1.5,
      partying == "2" ~ 2,
      partying == "3" ~ 3,
      partying == "4+" ~ 4,
      TRUE ~ NA_real_
    ),
    missed_num = case_when(
      classes_missed == "0" ~ 0,
      classes_missed == "1" ~ 1,
      classes_missed == "2" ~ 2,
      classes_missed == "3" ~ 3,
      classes_missed == "4+" ~ 4,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(!is.na(failed_any), !is.na(party_num), !is.na(missed_num))

# 2. Budowa modelu regresji logistycznej
model_ryzyka <- glm(failed_any ~ party_num + missed_num, 
                    data = dane_model, 
                    family = binomial)

# 3. WyciƒÖgniƒôcie Iloraz√≥w Szans (Odds Ratios)
wyniki_modelu <- tidy(model_ryzyka, exponentiate = TRUE, conf.int = TRUE) %>%
  filter(term != "(Intercept)") # Usuwamy sta≈ÇƒÖ dla czytelno≈õci wykresu

# 4. Wizualizacja: Forest Plot
ggplot(wyniki_modelu, aes(x = estimate, y = term)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2, color = "#2c3e50") +
  geom_point(size = 4, color = "#e74c3c") +
  scale_y_discrete(labels = c("party_num" = "Czƒôstotliwo≈õƒá imprezowania", 
                              "missed_num" = "Opuszczanie zajƒôƒá")) +
  labs(
    title = "Iloraz Szans niezdania przedmiotu",
    subtitle = "Warto≈õci > 1 oznaczajƒÖ wzrost ryzyka. Czerwona linia (1.0) to brak wp≈Çywu.",
    x = "Ryzyko",
    y = ""
  ) +
  theme_minimal()

# 1. Przygotowanie czytelnej tabeli na podstawie wcze≈õniej stworzonego modelu
tabela_wynikow <- wyniki_modelu %>%
  select(
    `Czynnik` = term,
    `Iloraz Szans (OR)` = estimate,
    `B≈ÇƒÖd standardowy` = std.error,
    `Statystyka z` = statistic,
    `Warto≈õƒá p (p-value)` = p.value,
    `Dolna granica (95%)` = conf.low,
    `G√≥rna granica (95%)` = conf.high
  ) %>%
  mutate(
    # Mapowanie nazw na bardziej przyjazne
    Czynnik = case_when(
      Czynnik == "party_num" ~ "Czƒôstotliwo≈õƒá imprezowania",
      Czynnik == "missed_num" ~ "Liczba opuszczonych zajƒôƒá",
      TRUE ~ Czynnik
    )
  )

# 2. Generowanie tabeli kable
kable(
  tabela_wynikow, 
  digits = 3, # ZaokrƒÖglenie do 3 miejsc po przecinku
  caption = "Wyniki regresji logistycznej dla ryzyka niezdania przedmiot√≥w",
  align = 'lcccccc' # Wyr√≥wnanie: lewo dla tekstu, ≈õrodek dla liczb
)

```

```{r zrobienie danych do wykresu ≈Çokciowego, include=FALSE}
dane_analiza <- dane %>%
  mutate(
    # --- NOWE ZMIENNE POTRZEBNE DO KLASTROWANIA I INNYCH ANALIZ ---
    drinks_num_score = case_when(
      drinks == "0" ~ 0,
      drinks == "1-3" ~ 2,
      drinks == "3-5" ~ 4,
      drinks == "5-8" ~ 6.5,
      drinks == "8+" ~ 10,
      TRUE ~ NA_real_
    ),
    party_num_score = case_when(
      partying == "0" ~ 0,
      partying == "1" ~ 1,
      partying == "Only weekends" ~ 1.5,
      partying == "2" ~ 2,
      partying == "3" ~ 3,
      partying == "4+" ~ 4, # lub 5, w zale≈ºno≈õci jak ustali≈Çe≈õ w modelu logitowym
      TRUE ~ NA_real_
    ),
    study_num_score = case_when(
      studying == "0" ~ 0,
      studying == "1-3" ~ 1.5,
      studying == "3-5" ~ 4,
      studying == "5-8" ~ 6.5,
      studying == "8+" ~ 10,
      TRUE ~ NA_real_
    ),

    # --- TWOJE DOTYCHCZASOWE ZMIENNE ---
    # Konwersja allowance na warto≈õƒá numerycznƒÖ (≈õrodek przedzia≈Çu)
    allow_val = case_when(
      allowance == "R 0 - R 1000" ~ 500,
      allowance == "R 1001 - R 2000" ~ 1500,
      allowance == "R 2001 - R 3000" ~ 2500,
      allowance == "R 3001 - R 4000" ~ 3500,
      allowance == "R 4001- R 5000" ~ 4500,
      allowance == "R 5001 - R 6000" ~ 5500,
      allowance == "R 6001 - R 7000" ~ 6500,
      allowance == "R 7001 - R 8000" ~ 7500,
      allowance == "R 8001+" ~ 9000,
      TRUE ~ 0
    ),
    # Grupowanie dochodu dla lepszej czytelno≈õci (Niski vs Wysoki)
    allow_group = ifelse(allow_val > 4000, "Wysoki bud≈ºet", "Niski bud≈ºet"),
    # Skala towarzyska (Partying + Drinks)
    social_index = recode(partying, "0"=0, "1"=1, "2"=2, "3"=3, "4+"=4, "Only weekends"=1.5) +
                   recode(drinks, "0"=0, "1-3"=2, "3-5"=4, "5-8"=6, "8+"=9),
    # Wynik akademicki (hybrydowy)
    grade_final = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  )
```

```{r elbow_plot, echo=FALSE, message=FALSE, warning=FALSE}
# --- PRZYGOTOWANIE DANYCH ---
dane_do_klastrowania <- dane_analiza %>%
  select(drinks_num_score, party_num_score, study_num_score, grade_final) %>%
  na.omit() %>%
  scale()

# --- GENEROWANIE ≈ÅADNIEJSZEGO WYKRESU ---
fviz_nbclust(dane_do_klastrowania, kmeans, method = "wss", linecolor = "#2c3e50") + # Zmiana koloru linii na granatowy
  geom_vline(xintercept = 3, linetype = "dashed", color = "#e74c3c", size = 1) +    # Czerwona linia przerywana
  geom_point(size = 3, color = "#2c3e50") +                                         # Wiƒôksze kropki
  labs(title = "Optymalna liczba grup (Metoda ≈Åokcia)",
       subtitle = "Wykres sugeruje podzia≈Ç student√≥w na 3 profilowane grupy (klastry)",
       x = "Liczba klastr√≥w (k)",
       y = "Zmienno≈õƒá wewnƒÖtrz grupy (WSS)") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 10)
  )
```

**Interpretacja:**
Metoda ≈Çokcia wskazuje na punkt "zagiƒôcia" krzywej przy warto≈õci **k = 3**. Oznacza to, ≈ºe po wyodrƒôbnieniu trzech grup, dalsze rozdrabnianie populacji nie przynosi istotnego wzrostu jako≈õci dopasowania. Sugeruje to istnienie trzech g≈Ç√≥wnych archetyp√≥w zachowa≈Ñ w≈õr√≥d badanych student√≥w.

# Wnioskowanie statystyczne

Sprawdzamy, czy ≈õrodowisko akademika sprzyja gorszemu GPA w por√≥wnaniu do mieszkania prywatnego. Zosta≈Ça zbadana r√≥≈ºnica w wynikach w ostatnim roku dla student√≥w, kt√≥rzy sƒÖ teraz przynajmniej na 2 roku.

```{r wnioskowanie statystyczne akademiki vs GPA, echo=FALSE, warning=FALSE}
# Wykorzystujemy test Wilcoxona (odporny na brak rozk≈Çadu normalnego)
test_wynik <- wilcox.test(grade_last_y ~ accomodation, data = dane)

# Wizualizacja
ggplot(dane, aes(x = accomodation, y = grade_last_y, fill = accomodation)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Por√≥wnanie GPA wzglƒôdem miejsca zamieszkania",
       subtitle = paste("p-value =", round(test_wynik$p.value, 4))) +
  theme_minimal()
```



```{r pytanie 4 test chi kwadrat, echo=FALSE, warning=FALSE}
# 1. Przygotowanie tabeli kontyngencji i testu
tab <- table(dane$parents_alcohol_approval, dane$drinks)
chi_test <- chisq.test(tab)

# 2. Wizualizacja: Heatmapa natƒô≈ºenia
dane %>%
  filter(!is.na(parents_alcohol_approval), !is.na(drinks)) %>%
  count(parents_alcohol_approval, drinks) %>%
  group_by(parents_alcohol_approval) %>%
  mutate(procent = n / sum(n) * 100) %>%
  ggplot(aes(x = drinks, y = parents_alcohol_approval, fill = procent)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#f7fbff", high = "#084594") +
  geom_text(aes(label = paste0(round(procent, 1), "%")), color = "black", size = 3) +
  labs(title = "Relacja: Aprobata rodzic√≥w vs Spo≈ºycie alkoholu",
       x = "Liczba drink√≥w", y = "Aprobata rodzic√≥w", fill = "% w grupie") +
  theme_minimal()

# 3. Profesjonalna tabela wynik√≥w testu
tidy(chi_test) %>%
  select(`Statystyka Chi2` = statistic, `df` = parameter, `p-value` = p.value) %>%
  kable(digits = 4, caption = "Wyniki testu istotno≈õci Chi-kwadrat")
```


```{r r√≥≈ºnice miƒôdzy wydzia≈Çami, echo=FALSE}

dane_fac <- dane %>%
  mutate(drinks_num = case_when(
    drinks == "0" ~ 0,
    drinks == "1-3" ~ 2,
    drinks == "3-5" ~ 4,
    drinks == "5-8" ~ 6.5,
    drinks == "8+" ~ 10,
    TRUE ~ NA_real_
  )) %>%
  filter(!is.na(faculty), !is.na(drinks_num))

# 2. Test statystyczny Kruskala-Wallisa
kw_test <- kruskal.test(drinks_num ~ faculty, data = dane_fac)

# 3. Wykres ≈õredniego spo≈ºycia na wydzia≈Çach
dane_fac %>%
  group_by(faculty) %>%
  summarise(srednia_drinkow = mean(drinks_num), n = n()) %>%
  filter(n > 2) %>% # Odrzucamy wydzia≈Çy z bardzo ma≈ÇƒÖ liczbƒÖ student√≥w
  ggplot(aes(x = reorder(faculty, srednia_drinkow), y = srednia_drinkow, fill = srednia_drinkow)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_viridis_c(option = "mako", direction = -1) +
  labs(title = "≈örednie spo≈ºycie alkoholu na wydzia≈Çach",
       subtitle = paste("Test Kruskala-Wallisa p-value:", round(kw_test$p.value, 4)),
       x = "", y = "≈örednia liczba drink√≥w (indeks)") +
  theme_minimal() +
  theme(legend.position = "none")

```

