---
title: "Alcohol Driven Cognitive Performance Disruption in Univeristy Students"
author: "Oskar Iwaszkiewicz, Bartłomiej Duda, Kajetan Bernat, Olga Dawidowicz"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme:
      bootswatch: cosmo  
    toc: true
    toc_float: true      
---

```{r pakiety, include=FALSE}
library(naniar)
library(dplyr)
library(tidyverse)
library(finalfit)
library(mice)
library(ggmice)
library(VIM)
library(ggplot2)
library(kableExtra)
library(knitr)
library(validate)
library(factoextra)
library(plotly)
library(shiny)
library(prettydoc)
library(flexdashboard)
library(ggalluvial)
library(ggdist)
library(tidyquant)
library(modelsummary)
library(ggstatsplot)
library(sjPlot)
library(car)
library(scales)
library(flextable)
```

# Wprowadzenie
## Cel badania
Celem niniejszego projektu jest zbadanie wielowymiarowych zależności między spożyciem alkoholu, towarzyszącym mu stylem życia a wynikami w nauce (GPA) oraz funkcjonowaniem poznawczym studentów uniwersyteckich. Problem ten jest istotny ze względu na powszechność kultury picia w środowisku akademickim i jej potencjalnie negatywny wpływ na karierę edukacyjną.
Analiza opiera się na danych ankietowych obejmujących zmienne demograficzne, ekonomiczne (stypendia, zakwaterowanie), społeczne (relacje z rodzicami) oraz behawioralne (częstotliwość imprezowania, absencja na zajęciach). W toku prac dane poddano czyszczeniu oraz imputacji, aby zapewnić rzetelność wnioskowania statystycznego.

## Pytania badawcze

W ramach analizy postawiono następujące pytania badawcze, mające na celu zgłębienie mechanizmów rządzących badanym zjawiskiem:

1. **Bezpośredni wpływ alkoholu na wyniki:** Czy istnieje istotna statystycznie, ujemna korelacja między ilością spożywanego alkoholu a średnią ocen (GPA)?
2. **Rola statusu ekonomicznego:** Czy wyższy dochód rozporządalny (`allowance`) stymuluje intensywniejsze życie towarzyskie, pośrednio wpływając na obniżenie wyników w nauce?
3. **Środowisko zamieszkania a kultura studencka:** Czy rodzaj zakwaterowania (sektor prywatny/dom rodzinny vs. akademiki) różnicuje siłę związku między spożyciem alkoholu a liczbą opuszczonych zajęć?
4. **Psychospołeczne determinanty:** Czy jakość relacji z rodzicami oraz ich aprobata dla spożywania alkoholu stanowią istotne predyktory ryzykownych zachowań studentów?
5. **Efekt kompensacji:** Czy zwiększony nakład pracy własnej (dodatkowe godziny nauki w tygodniu) jest w stanie zniwelować negatywny wpływ "imprezowego stylu życia" na średnią ocen?
6. W jakim stopniu "imprezowy styl życia" zwiększa ryzyko niezdania przedmiotów?
7. **Różnice międzypłciowe (Gender Gap):** Czy płeć studenta różnicuje wzorce spożycia alkoholu oraz czy moderuje siłę związku między piciem a wynikami w nauce?


```{r data wrangling, include=FALSE}
dane <- read.csv("Stats survey.csv")
dane[dane == ""] <- NA
dane <- dane %>% select(-Timestamp)
dane <- dane %>% rename(sex = Your.Sex.,
                        grade_12 = Your.Matric..grade.12..Average..GPA..in...,
                        last_year = What.year.were.you.in.last.year..2023...,
                        faculty = What.faculty.does.your.degree.fall.under.,
                        grade_last_y = Your.2023.academic.year.average.GPA.in....Ignore.if.you.are.2024.1st.year.student.,
                        accomodation = Your.Accommodation.Status.Last.Year..2023.,
                        allowance = Monthly.Allowance.in.2023,
                        scholarship = Were.you.on.scholarship.bursary.in.2023.,
                        studying = Additional.amount.of.studying..in.hrs..per.week,
                        partying = How.often.do.you.go.out.partying.socialising.during.the.week..,
                        drinks = On.a.night.out..how.many.alcoholic.drinks.do.you.consume.,
                        classes_missed =  How.many.classes.do.you.miss.per.week.due.to.alcohol.reasons...i.e..being.hungover.or.too.tired..,
                        modules_failed = How.many.modules.have.you.failed.thus.far.into.your.studies.,
                        relationship = Are.you.currently.in.a.romantic.relationship.,
                        parents_alcohol_approval = Do.your.parents.approve.alcohol.consumption.,
                        relationship_w_parents =How.strong.is.your.relationship.with.your.parent.s.)

dane$sex <- ifelse(dane$sex == "Female", 0, ifelse(dane$sex == "Male", 1, dane$sex))
dane$sex <- factor(dane$sex, levels = c(0,1), labels = c("Kobieta", "Mężczyzna"))
dane$last_year <- ifelse(is.na(dane$last_year) & is.na(dane$grade_last_y), "12th class", dane$last_year)
dane$last_year <- factor(dane$last_year, levels = c("12th class", "1st Year", "2nd Year", "3rd Year", "4th Year", "Postgraduate"))
dane$faculty <- factor(dane$faculty, levels = unique(dane$faculty))
dane$accomodation <- ifelse(grepl("^Private.*", dane$accomodation), 1, ifelse(grepl("^Non.*", dane$accomodation), 0, dane$accomodation))
dane$accomodation <- factor(dane$accomodation, levels = c(0,1), labels = c("Nonprivate", "Private"))
dane$allowance <- factor(dane$allowance, levels = c("R 4001- R 5000", "R 5001 - R 6000", "R 6001 - R 7000", "R 7001 - R 8000", "R 8000+"))
dane$scholarship <- ifelse(dane$scholarship == "No", 0, ifelse(grepl("^Yes.*", dane$scholarship),1,dane$scholarship))
dane$scholarship <- factor(dane$scholarship, levels = c(0,1), labels = c("No", "Yes"))
dane$studying <- factor(dane$studying, levels = c("0", "1-3", "3-5", "5-8", "8+"))
dane$partying <- factor(dane$partying, levels = c("0", "1", "Only weekends", "2", "3", "4+"))
dane$drinks <- factor(dane$drinks, levels = c("0", "1-3", "3-5", "5-8", "8+"))
dane$classes_missed <- factor(dane$classes_missed, levels = c("0", "1", "2", "3",  "4+"))
dane$modules_failed <- factor(dane$modules_failed, levels = c("0", "1", "2", "3",  "4+"))
dane$relationship <- ifelse(dane$relationship == "No", 0, ifelse(dane$relationship == "Yes", 1, dane$relationship))
dane$relationship <- factor(dane$relationship, levels = c(0,1), labels = c("No", "Yes"))
dane$parents_alcohol_approval <- ifelse(dane$parents_alcohol_approval == "No", 0, ifelse(dane$parents_alcohol_approval == "Yes", 1, dane$parents_alcohol_approval))
dane$parents_alcohol_approval <- factor(dane$parents_alcohol_approval, levels = c(0,1), 
                                        labels = c("No", "Yes"))
dane$relationship_w_parents <- factor(dane$relationship_w_parents, levels = c("Distant", "Fair", "Close", "Very close"))
```

# Czyszczenie danych

W tym etapie surowe dane ankietowe zostały poddane standaryzacji i transformacji, aby umożliwić ich dalszą analizę statystyczną. Wykonano następujące operacje:

* **Selekcja i nazewnictwo:** Usunięto zbędne kolumny (np. znaczniki czasowe) oraz nadano zmiennym intuicyjne nazwy (np. `sex`, `grade_12`, `drinks`), zastępując długie pytania z kwestionariusza (Tabela 1).
* **Kodyfikacja zmiennych:**
    * Zmienne binarne (np. płeć, stypendium) przekodowano na format **0-1**.
    * Zmienne opisowe (np. przedziały dochodów, liczba drinków) zamieniono na **skalę porządkową**, co pozwoli na zachowanie hierarchii danych w modelach korelacji.
* **Logika dla pierwszego roku:** Zidentyfikowano specyficzną grupę studentów pierwszego roku ("12th class"). Ich braki danych w kolumnie ocen z poprzedniego roku akademickiego (`grade_last_y`) nie są błędem, lecz wynikają ze struktury badania (brak historii studiowania). Zostało to uwzględnione w procesie czyszczenia.
* **Walidacja danych:** Zostały również sprawdzone ograniczenia, które musiały obejmować zmienne i zostały pod tym kątem sprawdzone.
* **Duplikaty:** Wśród obserwacji były również duplikaty, jednak przez bardzo małą ich ilość (2) założyliśmy, że istnieje możliwość na zaistnienie takiej sytuacji, więc nie zostały one usunięte.

```{r diagnostyka, include=FALSE}
#sprawdzenie sensu danych 
rules <- validator(
  Oceny_12_klasa = (grade_12 >= 0 & grade_12 <= 100) | is.na(grade_12),
  Oceny_zeszly_rok = (grade_last_y >= 0 & grade_last_y <= 100) | is.na(grade_last_y),
  Brak_oceny_12_klasa = if (last_year == "12th class") is.na(grade_last_y)
)
out <- confront(dane, rules)
summary(out)

#sprawdzenie NA w ostatniej zasadzie
dane %>% 
  filter(is.na(last_year))

#sprawdzenie duplikatów
sum(duplicated(dane))
dane %>%
  filter(duplicated(.))
dane %>% 
  filter(grade_12 == 85 & grade_last_y == 73)
dane %>% 
  filter(grade_12 == 71 & is.na(grade_last_y))

#usunięcie wierszy z brakami bez imputacji
dane <- dane %>% filter(!is.na(sex))
dane <- dane %>% filter(!is.na(faculty))
dane <- dane %>% filter(!is.na(last_year))

```


```{r tabela-zmiennych, echo=FALSE}

slownik <- data.frame(
  "Nazwa_Zmiennej" = c(
    "sex", "grade_12", "last_year", "faculty", "grade_last_y", 
    "accomodation", "allowance", "scholarship", "studying", 
    "partying", "drinks", "classes_missed", "modules_failed", 
    "relationship", "parents_alcohol_approval", "relationship_w_parents"
  ),
  "Opis_Pytania" = c(
    "Płeć respondenta",
    "Średnia ocen z 12 klasy (GPA)",
    "Rok studiów w roku 2023",
    "Kierunek studiów",
    "Średnia ocen za rok akademicki 2023",
    "Status zakwaterowania (prywatne vs publiczne)",
    "Miesięczny budżet",
    "Czy student posiadał stypendium",
    "Dodatkowe godziny nauki tygodniowo",
    "Częstotliwość wychodzenia na imprezy",
    "Liczba drinków spożywanych jednej nocy",
    "Liczba zajęć opuszczonych przez alkohol",
    "Liczba niezdanych przedmiotów",
    "Czy student jest w związku",
    "Czy rodzice akceptują spożywanie alkoholu",
    "Relacja z rodzicami"
  )
)

# Generowanie ładnej tabeli
kable(slownik, 
      col.names = c("Nazwa zmiennej", "Opis zmiennej"),
      caption = "Tabela 1: Słownik zmiennych") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = F, 
                position = "left") %>%
  column_spec(1, bold = TRUE, color = "#2c3e50") %>% # Wyróżnienie nazw zmiennych
  column_spec(2, width = "30em") # Poszerzenie opisu dla czytelności
```

# Analiza i diagnoza braków danych

```{r wizualizacja braków, echo=FALSE, warning=FALSE, fig.show='hold', out.width='50%', fig.height=6}
gg_miss_upset(dane, nsets = 5, nintersects = 10)


gg_miss_var(dane, show_pct = TRUE) + 
  labs(title = "Procentowy udział braków danych w zmiennych",
       y = "% Brakujących wartości",
       x = "Zmienne") +
  theme_minimal()

```

Przed przystąpieniem do imputacji (uzupełniania) danych, przeprowadzono wizualną inspekcję brakujących wartości przy użyciu pakietów `naniar` i `ggmice`. Pozwoliło to na podjęcie kluczowych decyzji:

1. **Eliminacja rekordów:** Usunięto obserwacje posiadające braki w kluczowych zmiennych strukturalnych: `sex` (płeć), `faculty` (wydział) oraz `last_year` (rok studiów). Zmienne te definiują profil studenta i są trudne do wiarygodnego, sztucznego odtworzenia.
2. **Identyfikacja mechanizmu braków:** Potwierdzono, że część braków ma charakter strukturalny (wspomniani studenci pierwszego roku), co wyklucza prostą imputację średnią dla całej populacji.

```{r imputacja danych, warning=FALSE, include=FALSE}
dane_imp <- kNN(dane, variable = c("grade_last_y", "grade_12", "accomodation", "allowance", "scholarship", "studying", "classes_missed", "modules_failed"), k = 5)

dane$grade_last_y <- as.numeric(ifelse(dane$last_year != "12th class" & is.na(dane$grade_last_y), dane_imp$grade_last_y, dane$grade_last_y))

dane <- dane %>%
  mutate(
    allowance = coalesce(allowance, dane_imp$allowance),
    scholarship = coalesce(scholarship, dane_imp$scholarship),
    accomodation = coalesce(accomodation, dane_imp$accomodation),
    grade_12 = coalesce(grade_12, dane_imp$grade_12),
    studying = coalesce(studying, dane_imp$studying),
    classes_missed = coalesce(classes_missed, dane_imp$classes_missed),
    modules_failed = coalesce(modules_failed, dane_imp$modules_failed)
  )

```

# Imputacja danych

Pozostałe braki danych (w zmiennych takich jak `allowance`, `scholarship` czy `grades`) uzupełniono, wykorzystując algorytm **k-Nearest Neighbors (kNN)**. Metoda ta polega na znalezieniu dla każdej niepełnej obserwacji grupy najbardziej podobnych do niej studentów ("sąsiadów") i uzupełnieniu braku na podstawie ich danych.

**Dobór parametru $k=5$:**

Zdecydowano się na ustawienie parametru liczby sąsiadów na $k=5$. Jest to optymalny kompromis:

* Wartość ta jest wystarczająco duża, aby zminimalizować wpływ pojedynczych wartości odstających (szumu w danych).
* Jednocześnie jest wystarczająco mała, aby zachować lokalną strukturę danych i nie doprowadzić do nadmiernego "wygładzenia" (uśrednienia) specyficznych cech studentów.

Dla zmiennej `grade_last_y` zastosowano podejście hybrydowe: imputacja została przeprowadzona, a następnie skorygowana logicznie dla studentów pierwszego roku, aby nie przypisywać im sztucznych ocen z okresu, gdy nie studiowali.

Dodatkowo braki pozostawiono w zmiennych takich jak: `relationship`, `parents_alcohol_approval` oraz `relationship_w_parents` ze względu na trudność przewidzenia tak osobistych danych przez metody imputacji. 

```{r wizualizacja imputacji, echo=FALSE, fig.height=6, fig.show='hold', warning=FALSE, out.width='50%'}
#jakość imputcji

ggplot(dane_imp, aes(x = allowance, y = grade_12, color = allowance_imp)) +
  geom_jitter(alpha = 0.6, width = 0.2, size = 2.5) +
  scale_color_manual(values = c("skyblue3", "firebrick1"), 
                     labels = c("Oryginalne", "Imputowane")) +
  labs(title = "Weryfikacja imputacji: Miesięczny budżet (allowance)",
       subtitle = "Rozkład ocen względem budżetu z zaznaczeniem wartości uzupełnionych",
       x = "Kategoria budżetu (allowance)",
       y = "Średnia ocen (grade_12)",
       color = "Status danych") +
  theme_minimal()

ggplot(dane_imp, aes(x = accomodation, y = grade_12, color = accomodation_imp)) +
  geom_jitter(alpha = 0.6, width = 0.15, size = 2.5) +
  scale_color_manual(values = c("skyblue3", "firebrick1"), 
                     labels = c("Oryginalne", "Imputowane")) +
  labs(title = "Weryfikacja imputacji: Zakwaterowanie (accomodation)",
       subtitle = "Rozkład ocen względem rodzaju zakwaterowania",
       x = "Rodzaj zakwaterowania",
       y = "Średnia ocen (grade_12)",
       color = "Status danych") +
  theme_minimal()

```

## Weryfikacja jakości imputacji
W celu potwierdzenia poprawności działania algorytmu wygenerowano wykresy typu stripplot dla zmiennych `allowance` oraz `accommodation`. Zdecydowaliśmy się akurat na te zmienne ze względu na to, że tylko one mają braki na poziomie co najmniej 5% (oprócz braków strukturalnych w `grade_12`).

Wybrano zestawienie tych kategorii ze zmienną `grade_12`, aby sprawdzić, czy wartości uzupełnione (zaznaczone na czerwono) naturalnie wpisują się w rozkład danych oryginalnych. Brak wyraźnych skupisk punktów imputowanych poza chmurą danych zaobserwowanych potwierdza, że proces uzupełniania nie wprowadził zniekształceń do struktury zbioru.

# Wizualizacja danych

```{r klastrowanie, echo=FALSE}
# 1. Przygotowanie danych
dane_clust <- dane %>%
  mutate(
    party_num = case_when(
       partying == "0" ~ 0, partying == "1" ~ 1, partying == "Only weekends" ~ 1.5,
       partying == "2" ~ 2, partying == "3" ~ 3, partying == "4+" ~ 4, TRUE ~ 0
    ),
    drinks_num = case_when(
       drinks == "0" ~ 0, drinks == "1-3" ~ 2, drinks == "3-5" ~ 4,
       drinks == "5-8" ~ 6.5, drinks == "8+" ~ 10, TRUE ~ 0
    ),
    study_num = case_when(
       studying == "0" ~ 0, studying == "1-3" ~ 1.5, studying == "3-5" ~ 4,
       studying == "5-8" ~ 6.5, studying == "8+" ~ 10, TRUE ~ 0
    ),
    missed_num = case_when(
       classes_missed == "0" ~ 0, classes_missed == "1" ~ 1, classes_missed == "2" ~ 2,
       classes_missed == "3" ~ 3, classes_missed == "4+" ~ 4, TRUE ~ 0
    ),
    failed_num = case_when(
       modules_failed == "0" ~ 0, modules_failed == "1" ~ 1, modules_failed == "2" ~ 2,
       modules_failed == "3" ~ 3, modules_failed == "4+" ~ 4, TRUE ~ 0
    ),
    grade = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  ) %>%
  select(study_num, party_num, drinks_num, missed_num, failed_num, grade) %>%
  na.omit()

# 2. Obliczenia
set.seed(123) 
km <- kmeans(scale(dane_clust), centers = 3) 
pca <- prcomp(scale(dane_clust))

# 3. Przygotowanie danych do wykresu
df_pca <- data.frame(pca$x[,1:2], cluster = factor(km$cluster)) %>%
  bind_cols(dane_clust) %>%
  mutate(
    Archetyp = case_when(
      cluster == 1 ~ "Imprezowicz",
      cluster == 2 ~ "Przeciętniak",
      cluster == 3 ~ "Prymus"
    ),
    opis_dymka = paste0(
      "<b>Archetyp: </b>", Archetyp, "<br>",
      "Średnia ocena: ", round(grade, 1), "%<br>",
      "Nauka: ", study_num, " h/tydz<br>",
      "Imprezy (index): ", party_num, "<br>",
      "Drinki (index): ", drinks_num
    )
  )

# 4. Wykres (TU JEST ZMIANA: geom_jitter zamiast geom_point)
p <- ggplot(df_pca, aes(x = PC1, y = PC2, color = Archetyp, text = opis_dymka)) +
  # Używamy jitter, żeby "roztrząsnąć" punkty.
  # width i height kontrolują, jak bardzo mają się rozsunąć.
  # Zmniejszyłem też trochę size (na 3), żeby było czytelniej.
  geom_jitter(size = 2, alpha = 0.5, width = 0.12, height = 0.12) +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Mapa Archetypów Studentów",
       subtitle = "Analiza PCA (Punkty lekko rozsunięte dla czytelności)",
       x = "Wymiar 1 (Styl życia)", 
       y = "Wymiar 2 (Wyniki)", 
       color = "Profil") +
  theme_minimal() +
  theme(legend.position = "bottom")

# 5. Wyświetlanie
ggplotly(p, tooltip = "text")

```

```{r zrobienie danych, include=FALSE}
dane_analiza <- dane %>%
  mutate(
    # 1. Konwersja allowance na wartość numeryczną
    allow_val = case_when(
      allowance == "R 0 - R 1000" ~ 500,
      allowance == "R 1001 - R 2000" ~ 1500,
      allowance == "R 2001 - R 3000" ~ 2500,
      allowance == "R 3001 - R 4000" ~ 3500,
      allowance == "R 4001- R 5000" ~ 4500,
      allowance == "R 5001 - R 6000" ~ 5500,
      allowance == "R 6001 - R 7000" ~ 6500,
      allowance == "R 7001 - R 8000" ~ 7500,
      allowance == "R 8001+" ~ 9000,
      TRUE ~ 0
    ),
    
    # 2. Grupowanie budżetu
    allow_group = ifelse(allow_val > 4000, "Wysoki budżet", "Niski budżet"),
    
    # 3. Skala towarzyska (zastępujemy problematyczne recode funkcją case_when)
    party_score = case_when(
      partying == "0" ~ 0,
      partying == "1" ~ 1,
      partying == "2" ~ 2,
      partying == "3" ~ 3,
      partying == "4+" ~ 4,
      partying == "Only weekends" ~ 1.5,
      TRUE ~ 0
    ),
    
    drink_score = case_when(
      drinks == "0" ~ 0,
      drinks == "1-3" ~ 2,
      drinks == "3-5" ~ 4,
      drinks == "5-8" ~ 6,
      drinks == "8+" ~ 9,
      TRUE ~ 0
    ),
    
    # Łączymy wyniki w jeden indeks
    social_index = party_score + drink_score,
    
    # 4. Wynik akademicki (hybrydowy)
    grade_final = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  )
```

## Wpływ statusu ekonomicznego na styl życia i wyniki

W tej sekcji postaraliśmy się odpowiedzieć na pytanie badawcze **czy wyższy dochód rozporządzalny stymuluje intensywniejsze życie towarzyskie?**

```{r pytanie 2, echo=FALSE}
ggplot(dane_analiza, aes(x = social_index, y = grade_final)) +
  # Generowanie chmur gęstości
  geom_density_2d_filled(alpha = 0.8) +
  facet_wrap(~allow_group) + 
  
  # Ustawienie kolorów i etykiet (uproszczone: tylko Niska i Wysoka)
  scale_fill_viridis_d(
    option = "plasma",
    labels = c("Niska", "", "", "", "", "", "", "", "","", "Wysoka")
  ) +
  
  labs(
    title = "Koncentracja studentów: Nauka vs Zabawa",
    subtitle = "Zależność między budżetem a stylem życia.",
    x = "Indeks Towarzyski",
    y = "Wynik Akademicki (GPA %)",
    fill = "Gęstość występowania:"
  ) +
  
  theme_minimal() +
  theme(
    # Przeniesienie legendy na dół
    legend.position = "bottom",
    legend.box = "horizontal",
    # Pogrubienie tytułu i dodanie mu miejsca
    legend.title = element_text(face = "bold", size = 10),
    # KLUCZOWE: Dodanie marginesu na dole całego wykresu, żeby legenda się zmieściła
    plot.margin = margin(t = 10, r = 10, b = 25, l = 10),
    # Odstępy między panelami
    panel.spacing = unit(2, "lines"),
    strip.text = element_text(face = "bold")
  ) +
  
  # Konfiguracja wyglądu paska legendy
  guides(fill = guide_legend(
    nrow = 1, 
    # Wydłużenie paska (keywidth), żeby było go lepiej widać
    keywidth = unit(1.3, "cm"), 
    keyheight = unit(0.4, "cm"),
    # Ustawienie tytułu NAD paskiem (to rozwiązuje problem widoczności napisu)
    title.position = "top", 
    title.hjust = 0.5,
    label.position = "bottom"
  ))
```

### Metodologia i wskaźniki
Aby umożliwić obiektywne porównanie grup, wprowadzono dwa parametry analityczne:

* **Podział budżetu:** Próbę badawczą podzielono na dwa segmenty względem miesięcznego kieszonkowego:
    * **Niższy budżet:** $\le 5000$ R.
    * **Wyższy budżet:** $> 5000$ R.
* **Indeks Towarzyski:** Stworzono zagregowany wskaźnik (skala 0–13 pkt), będący sumą punktów za:
    * *Częstotliwość imprezowania* (`partying`): 0–4 pkt (w tym wartość 1.5 dla "Only weekends").
    * *Ilość spożywanego alkoholu* (`drinks`): 0–9 pkt.
    * Wskaźnik ten obrazuje **całkowitą intensywność stylu życia** studenta.

### Interpretacja mapy gęstości
Wizualizacja wykorzystuje metodę estymacji gęstości jądrowej (**2D Kernel Density**). Skala kolorystyczna wskazuje na stopień koncentracji obserwacji w danej przestrzeni.

### Kluczowe wnioski
1.  **Pieniądze jako stymulant:** W grupie z **wyższym budżetem** „ośrodek ciężkości” (żółty obszar) wyraźnie przesuwa się w prawą stronę osi X. Potwierdza to, że większe zasoby finansowe ułatwiają dostęp do płatnych rozrywek i sprzyjają **częstszej konsumpcji alkoholu**.
2.  **Zwiększone ryzyko akademickie:** Choć w obu grupach najwyższe oceny korelują z niską intensywnością imprezowania, grupa zasobna wykazuje znacznie większe **rozproszone w stronę wysokiej intensywności towarzyskiej**. Sugeruje to, że nadmiar środków sprzyja przedkładaniu zabawy nad obowiązki.
3.  **Dyscyplina niższych dochodów:** Studenci z niższym budżetem wykazują silniejszą koncentrację w obszarze **umiarkowanego życia towarzyskiego**, co przekłada się na statystycznie stabilniejsze i bardziej przewidywalne wyniki w nauce.

> **Podsumowanie:** Wyższy status ekonomiczny działa jako **katalizator życia towarzyskiego**. Zwiększając dostępność kosztownych rozrywek, staje się on pośrednim czynnikiem ryzyka dla wyników akademickich poprzez wyraźną zmianę priorytetów czasowych studenta.

## Środowisko zamieszkania a kultura studencka

```{r pytanie 3, echo=FALSE, message=FALSE}
# 1. Przygotowanie danych (konwersja na skale numeryczne)
dane_acc <- dane %>%
  mutate(
    # Uproszczenie nazw zakwaterowania
    acc_group = case_when(
      accomodation == "Nonprivate" ~ "Akademik",
      accomodation == "Private" ~ "Prywatne",
      TRUE ~ NA_character_
    ),
    # Konwersja drinków na liczby
    drinks_num = case_when(
      drinks == "0" ~ 0,
      drinks == "1-3" ~ 2,
      drinks == "3-5" ~ 4,
      drinks == "5-8" ~ 6.5,
      drinks == "8+" ~ 10,
      TRUE ~ NA_real_
    ),
    # Konwersja opuszczonych zajęć na liczby
    missed_num = case_when(
      classes_missed == "0" ~ 0,
      classes_missed == "1" ~ 1,
      classes_missed == "2" ~ 2,
      classes_missed == "3" ~ 3,
      classes_missed == "4+" ~ 5,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(!is.na(acc_group), !is.na(drinks_num), !is.na(missed_num))

# 2. Tworzenie wykresu korelacji z podziałem na grupy
ggplot(dane_acc, aes(x = drinks_num, y = missed_num, color = acc_group)) +
  # Jitter zapobiega nakładaniu się punktów na tych samych wartościach
  geom_jitter(alpha = 0.5, size = 2.5, width = 0.3, height = 0.3) +
  # Linie trendu dla każdej grupy
  geom_smooth(method = "lm", se = TRUE, size = 1.2) +
  # Facetowanie dla lepszego porównania
  facet_wrap(~acc_group) +
  scale_color_manual(values = c("Akademik" = "#e74c3c", "Prywatne" = "#3498db")) +
  labs(
    title = "Wpływ alkoholu na absencję a miejsce zamieszkania",
    subtitle = "Porównanie nachylenia linii trendu: im bardziej stroma linia, tym silniejszy negatywny wpływ.",
    x = "Liczba drinków podczas wyjścia",
    y = "Liczba opuszczonych zajęć / tydzień",
    color = "Miejsce zamieszkania:"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none", # Ukrywamy legendę, bo facety są podpisane
    strip.text = element_text(face = "bold", size = 12),
    plot.title = element_text(face = "bold")
  )
```


## Analiza efektu kompensacji

```{r pytanie 5, echo=FALSE, warning=FALSE}
# 1. Przygotowanie danych z nowymi nazwami zmiennych
dane_3d <- dane %>%
  mutate(
    # Konwersja godzin nauki (studying) na wartości numeryczne
    study_num = case_when(
      studying == "0" ~ 0,
      studying == "1-3" ~ 1.5,
      studying == "3-5" ~ 4,
      studying == "5-8" ~ 6.5,
      studying == "8+" ~ 10,
      TRUE ~ NA_real_
    ),
    # Konwersja częstotliwości imprez (partying) na liczby
    party_num = case_when(
      partying == "0" ~ 0,
      partying == "1" ~ 1,
      partying == "Only weekends" ~ 1.5,
      partying == "2" ~ 2,
      partying == "3" ~ 3,
      partying == "4+" ~ 5,
      TRUE ~ NA_real_
    ),
    # Ustalenie finalnego GPA (hybryda grade_last_y i grade_12)
    GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  ) %>%
  # Usunięcie braków danych dla tych konkretnych wymiarów
  filter(!is.na(study_num), !is.na(party_num), !is.na(GPA))

# 2. Tworzenie interaktywnego wykresu 3D
plot_ly(dane_3d, 
        x = ~party_num, 
        y = ~study_num, 
        z = ~GPA, 
        color = ~GPA, 
        colors = viridis::viridis(100), # Skala od fioletu (niskie) do żółtego (wysokie)
        type = "scatter3d", 
        mode = "markers",
        marker = list(size = 5, opacity = 0.8, line = list(color = 'white', width = 0.5)),
        text = ~paste("Student ID:", row.names(dane_3d),
                      "<br>Nauka:", study_num, "h/tydz", 
                      "<br>Imprezy (index):", party_num, 
                      "<br>Średnia:", GPA, "%")) %>%
  layout(
    scene = list(
      xaxis = list(title = "Intensywność imprez"),
      yaxis = list(title = "Dodatkowa nauka (h)"),
      zaxis = list(title = "Wynik akademicki (%)")
    ),
    title = "Trójwymiarowy model kompensacji: Nauka, Rozrywka i Wyniki"
  )
```





## Różnice międzypłciowe

```{r wykres pytanie 7, echo=FALSE, warning=FALSE}
# 1. DANE
dane_plot <- dane %>%
  filter(!is.na(drinks), !is.na(grade_last_y), !is.na(sex)) %>%
  mutate(drinks = factor(drinks, levels = c("0", "1-3", "3-5", "5-8", "8+")))

# 2. AGREGACJA
srednie_df <- dane_plot %>%
  group_by(sex, drinks) %>%
  summarise(srednia_ocena = mean(grade_last_y), .groups = "drop")

# 3. KOLORYSTYKA "MODERN TECH"
my_colors <- c("Kobieta" = "#FF2D55",  # Apple Pink / Coral
               "Mężczyzna" = "#007AFF") # Apple Blue

# 4. WYKRES BAZOWY
p <- ggplot() +
  
  # A. SKRZYPCE (TŁO)
  geom_violin(data = dane_plot, 
              aes(x = drinks, y = grade_last_y, color = sex, fill = sex),
              alpha = 0.1,            # Bardzo delikatne tło, żeby nie przytłaczało
              trim = TRUE,            
              size = 0.3,             # Cieniutki kontur
              position = position_dodge(width = 0.7)) +
  
  # B. LINIE TRENDU
  geom_line(data = srednie_df, 
            aes(x = drinks, y = srednia_ocena, group = sex, color = sex),
            size = 1.2, 
            position = position_dodge(width = 0.7)) +
  
  # C. PUNKTY (NOŚNIK INFORMACJI)
  # Tylko tutaj definiujemy 'text'
  geom_point(data = srednie_df, 
             aes(x = drinks, y = srednia_ocena, color = sex,
                 text = paste0("<b>", sex, "</b>",
                               "<br>Liczba drinków: ", drinks,
                               "<br>Średnia ocena: ", round(srednia_ocena, 1))),
             size = 3.5, shape = 18, # Nieco większe punkty dla czytelności
             position = position_dodge(width = 0.7)) +
  
  # D. ESTETYKA
  scale_color_manual(values = my_colors) +
  scale_fill_manual(values = my_colors) +
  scale_y_continuous(limits = c(30, 100)) + 
  labs(x = "Liczba drinków podczas wyjścia", y = "Średnia ocen (GPA)") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(), # Pionowe linie są zbędne przy kategoriach
    legend.position = "none"
  )

# 5. FINALNY PLOTLY + FIX DYMKÓW (NUCLEAR OPTION)
final_tech <- ggplotly(p, tooltip = "text") %>%
  layout(
    font = list(family = "Arial, sans-serif", size = 12, color = "#333333"),
    title = list(text = "<b>Czy płeć moderuje wpływ alkoholu na wyniki?</b>", 
                 y = 0.96, x = 0.05, xanchor = "left", font = list(size = 18)),
    legend = list(
      orientation = "h", xanchor = "center", x = 0.5, y = -0.15,
      title = list(text = "<b>Płeć: </b>"),
      itemclick = "toggleothers",
      itemdoubleclick = "toggle"
    ),
    margin = list(t = 70, b = 80, l = 60, r = 20),
    hovermode = "closest"
  ) %>%
  config(displayModeBar = FALSE)

for (i in seq_along(final_tech$x$data)) {
  # Sprawdzamy, czy dana warstwa to punkty (mode zawiera 'markers')
  # Jeśli nie (czyli to linie lub skrzypce), ustawiamy hoverinfo na 'skip'
  if (!grepl("markers", final_tech$x$data[[i]]$mode)) {
    final_tech$x$data[[i]]$hoverinfo <- "skip"
  }
}

final_tech
```

# Analiza opisowa

## Statystyki opisowe wyników akademickich (GPA)
```{r analiza opisowa rozklad ocen, echo=FALSE, message=FALSE, warning=FALSE}
# 1. Charakterystyka akademicka (GPA)
dane_desc <- dane %>%
  mutate(GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y))

# Statystyki opisowe ocen
stats_gpa <- dane_desc %>%
  summarise(
    N = n(),
    Średnia = round(mean(GPA, na.rm = TRUE), 2),
    Mediana = median(GPA, na.rm = TRUE),
    Odchylenie = round(sd(GPA, na.rm = TRUE), 2),
    Minimum = min(GPA, na.rm = TRUE),
    Maksimum = max(GPA, na.rm = TRUE)
  )

# Wyliczenie średniej do zmiennej (dla wygody)
srednia <- mean(dane_desc$GPA, na.rm = TRUE)

# 2. Wykres rozkładu ocen
plot_gpa <- ggplot(dane_desc, aes(x = GPA)) +
  geom_histogram(binwidth = 5, fill = "#3498db", color = "white", alpha = 0.8) +
  
  # DODANE: Liczby nad słupkami (tylko > 0)
  geom_text(stat = "bin", binwidth = 5, 
            aes(label = ifelse(after_stat(count) > 0, after_stat(count), "")), 
            vjust = -0.5, size = 3) +
  
  geom_vline(xintercept = srednia, linetype = "dashed", color = "red", size = 1) +
  
  # DODANE: Tekst z wartością średniej
  annotate("text", x = srednia + 1, y = 60, 
           label = paste0("Średnia: ", round(srednia, 2)), 
           color = "red", hjust = 0, fontface = "bold") +
  
  labs(title = "Rozkład ocen studentów (GPA %)", 
       subtitle = "Czerwona linia oznacza średnią",
       x = "Wynik (%)", y = "Liczba studentów") +
  theme_minimal()

# Wyświetlanie wyników
plot_gpa
kable(stats_gpa, caption = "Statystyki opisowe wyników akademickich (GPA)")
```

### Rozkład wyników akademickich (GPA)

Przeprowadzona analiza statystyczna zmiennej charakteryzującej wyniki w nauce (GPA) na próbie $N = 398$ studentów pozwala na sformułowanie następujących wniosków dotyczących struktury osiągnięć akademickich badanej populacji:

**1. Przeciętny poziom i typowy wynik**
Rozkład ocen przypomina klasyczną **krzywą Gaussa (rozkład normalny)**, co jest sytuacją pożądaną w statystyce. Potwierdza to fakt, że średnia ocena ($\bar{x} = 68.4\%$) jest niemal identyczna jak mediana ($Me = 68\%$). Taka zbieżność oznacza, że grupa jest symetryczna – nie ma tu wyraźnej przewagi osób z wynikami bardzo niskimi ani bardzo wysokimi. Najwięcej studentów (tzw. dominanta) uzyskuje wyniki w przedziale **70–75%**, co wskazuje, że standardem w badanej grupie jest poziom "dobry".

**2. Zróżnicowanie wyników (Dyspersja)**
Wartość odchylenia standardowego ($SD = 9.98$) świadczy o umiarkowanym zróżnicowaniu wyników. W praktyce oznacza to, że **większość badanej grupy** (ok. 68% studentów) mieści się w przedziale wyników od ok. **58% do 78%**. Sugeruje to, że poziom wiedzy studentów jest stosunkowo wyrównany, choć oczywiście występują naturalne różnice indywidualne.

**3. Rozpiętość osiągnięć**
Mimo koncentracji wyników wokół średniej, w grupie występuje pełne spektrum osiągnięć (rozstęp wynosi 66 punktów procentowych). Najniższy zanotowany wynik to **30%**, a najwyższy **96%**. Wskazuje to na obecność w badanej grupie zarówno nielicznych osób zagrożonych niezaliczeniem (widocznych na wykresie jako pojedyncze przypadki poniżej 40%), jak i studentów wybitnych. Są to jednak wyjątki na tle całej populacji.

**Podsumowanie:**
Zmienna GPA posiada pożądane właściwości statystyczne (bliskość rozkładu normalnego, brak drastycznych asymetrii), co czyni ją wiarygodnym wskaźnikiem do dalszych analiz korelacyjnych, np. w kontekście badania wpływu konsumpcji alkoholu na efektywność akademicką.

## Porównanie wyników kobiet i mężczyzn
Zastosowanie wizualizacji typu *Raincloud Plot*  łączącej estymator gęstości jądrowej, wykres pudełkowy oraz surowe dane punktowe pozwala na wielowymiarową ocenę zależności między płcią a efektywnością kształcenia.

```{r rozklad ocen wzgledem plci, echo=FALSE}
# Przygotowanie danych
dane_rain <- dane %>%
  mutate(GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y)) %>%
  filter(!is.na(sex), !is.na(GPA))

# Wykres Raincloud
ggplot(dane_rain, aes(x = sex, y = GPA, fill = sex)) +
  stat_halfeye(adjust = .5, width = .6, .width = 0, justification = -.3, point_colour = NA) +
  geom_boxplot(width = .15, outlier.shape = NA, alpha = 0.5) +
  geom_point(aes(color = sex), position = position_jitter(width = .05), size = 1, alpha = 0.4) +
  scale_fill_manual(values = c("Kobieta" = "deeppink3", "Mężczyzna" = "royalblue4")) +
  scale_color_manual(values = c("Kobieta" = "deeppink3", "Mężczyzna" = "royalblue4")) +
  labs(title = "Rozkład ocen względem płci",
       x = "", y = "Wynik akademicki (%)") +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none")
```

### Analiza porównawcza struktury ocen w podziale na płeć
**1. Przeciętny poziom wyników (Mediana)**
Analiza środkowych wartości na wykresach pokazuje, że przeciętny poziom ocen jest niemal identyczny dla obu płci. Zarówno kobiety, jak i mężczyźni osiągają medianę wyników w okolicach 68%. Oznacza to, że w badanej grupie płeć nie determinuje tego, czy ktoś uczy się przeciętnie lepiej, czy gorzej.

**2. Kształt rozkładu ocen**
Krzywe widoczne nad wykresami mają bardzo zbliżony kształt dla obu grup. Wskazuje to, że struktura ocen jest analogiczna, zarówno wśród kobiet, jak i mężczyzn najliczniejsze grupy studentów uzyskują podobne wyniki. Nie widać tutaj zjawiska, w którym jedna z płci dominowałaby wyraźnie w grupie najlepszych lub najsłabszych studentów.

**3. Zróżnicowanie i rozpiętość wyników**
Rozrzut punktów pod wykresem pokazuje, że w obu grupach występują bardzo zróżnicowane postawy. Zarówno wśród kobiet, jak i mężczyzn znajdziemy osoby z wynikami bardzo wysokimi, jak i pojedyncze przypadki wyników skrajnie niskich (poniżej 40%). Zakres zmienności jest porównywalny, co potwierdza, że poziom zróżnicowania wiedzy jest niezależny od płci.

**Pdsumowanie:**
Na podstawie analizy wizualnej można postawić hipotezę o braku istotnego statystycznie związku między płcią a wynikami GPA w badanej kohorcie. Ewentualne różnice są subtelne i prawdopodobnie nie mają znaczenia praktycznego.

## Profil studenta w kontekście statusu stypendialnego
```{r analiza_stypendium_final_v4, echo=FALSE, message=FALSE, warning=FALSE}
# 1. Przygotowanie danych
dane_tabs <- dane %>%
  mutate(
    GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y),
    Stypendium = factor(scholarship, 
                        levels = c("No", "Yes"), 
                        labels = c("Niestypendyści", "Stypendyści"))
  ) %>%
  select(GPA, Stypendium, Płeć = sex, `Nauka (h)` = studying, Imprezy = partying)

# 2. Statystyki dla GPA (Średnia i SD)
tab_gpa <- datasummary(GPA ~ Stypendium * (Mean + SD), 
                       data = dane_tabs, output = "data.frame")
colnames(tab_gpa) <- c("Cecha", "Mean1", "SD1", "Mean2", "SD2")
tab_gpa$Cecha <- "Średnia ocen (GPA)"

# 3. Statystyki dla zmiennych kategorycznych (N i %)
tab_cat <- datasummary_balance(~Stypendium, data = dane_tabs %>% select(-GPA), 
                               dinm = FALSE, output = "data.frame")
tab_cat <- tab_cat[, 1:5]
colnames(tab_cat) <- c("Cecha", "N1", "Pct1", "N2", "Pct2")

# Usuwamy puste wiersze nagłówkowe wygenerowane przez datasummary
tab_cat_clean <- tab_cat %>% filter(N1 != "" & !is.na(N1))

# 4. Połączenie wszystkiego w jedną strukturę

# Ujednolicamy nazwy kolumn we wszystkich zbiorach przed łączeniem
kolumny_cel <- c("Cecha", "Stat1", "Stat2", "Stat3", "Stat4")

# Przygotowanie wiersza z N
n_row <- data.frame(
  Cecha = "Liczba obserwacji (N)", 
  Stat1 = as.character(table(dane_tabs$Stypendium)[1]), 
  Stat2 = "", 
  Stat3 = as.character(table(dane_tabs$Stypendium)[2]), 
  Stat4 = "",
  stringsAsFactors = FALSE
)

# Ujednolicenie tab_gpa
colnames(tab_gpa) <- kolumny_cel

# Ujednolicenie tab_cat_clean
colnames(tab_cat_clean) <- kolumny_cel

# Funkcja pomocnicza do tworzenia niebieskich pasków nagłówkowych
make_header <- function(tytul) {
  setNames(data.frame(tytul, "", "", "", "", stringsAsFactors = FALSE), kolumny_cel)
}

# Łączenie
final_df <- rbind(
  n_row,
  tab_gpa,
  make_header("PŁEĆ"),
  tab_cat_clean[1:2, ],
  make_header("CZAS NAUKI"),
  tab_cat_clean[3:7, ],
  make_header("IMPREZOWANIE"),
  tab_cat_clean[8:nrow(tab_cat_clean), ]
)
# 5. Wykrywanie wierszy nagłówkowych (do pokolorowania sekcji)
indeksy_sekcji <- which(final_df[[2]] == "" & final_df[[3]] == "")

# 6. Budowa i stylizacja flextable
ft <- flextable(final_df) %>%
  # Dodanie górnego, podwójnego nagłówka z nazwami grup
  add_header_row(
    values = c("", "NIESTYPENDYŚCI", "STYPENDYŚCI"),
    colwidths = c(1, 2, 2)
  ) %>%
  # Ustawienie czytelnych nazw kolumn pod nagłówkami grup
  set_header_labels(
    Stat1 = "Mean(N)", Stat2 = "SD(%)",
    Stat3 = "Mean(N)", Stat4 = "SD(%)"
  ) %>%
  
  # STYLIZACJA KOLORYSTYCZNA
  # Główny nagłówek
  bg(part = "header", bg = "#1565c0") %>%
  color(part = "header", color = "white") %>%
  bold(part = "header") %>%
  
  # Wiersze sekcji
  bg(i = indeksy_sekcji, bg = "#e3f2fd") %>%
  color(i = indeksy_sekcji, color = "#1565c0") %>%
  bold(i = indeksy_sekcji) %>%
  
  # FORMATAWANIE TEKSTU I WYRÓWNANIE
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "all") %>%
  
  # Pogrubienie wiersza
  bold(i = 1) %>%
  
  # ESTETYKA
  border_inner_h(border = officer::fp_border(color = "#dcdcdc", width = 1)) %>%
  fix_border_issues() %>%
  autofit() %>%
  set_caption("Tabela: Profil studentów z uwzględnieniem statusu stypendialnego")

# Wyświetlenie gotowej tabeli
ft
```

### Analiza opisowa według stypendium

**1. Charakterystyka osiągnięć akademickich (GPA)**
Dane wskazują na dużą spójność obu grup w zakresie wyników nauczania. Średnia ocen (GPA) niestypendystów (68,48) jest niemal identyczna z wynikiem stypendystów (67,78). Sugeruje to, że w badanej populacji status stypendialny nie zależy wyłącznie od ocen, co może wskazywać na istotną rolę kryteriów socjalnych w procesie przyznawania wsparcia finansowego.

**2. Struktura demograficzna i reprezentacja płci**
Wyniki ujawniają wyraźną różnicę w rozkładzie płci wśród osób otrzymujących pomoc finansową. W grupie stypendystów odnotowano znaczną przewagę mężczyzn (60%), podczas gdy u niestypendystów podział ten jest bardziej wyrównany (53,5% vs 46,5%). Taka struktura może wynikać ze specyfiki sytuacji materialnej badanych grup lub uwarunkowań systemowych na danym wydziale.

**3. Inwestycja czasu w samokształcenie: Nauka**
Stypendyści wykazują wyższą dyscyplinę i większy nakład pracy własnej. W tej grupie nikt nie zadeklarował braku nauki (0% vs 5,7% u niestypendystów), a ponad 35% osób uczy się powyżej 8 godzin tygodniowo. Świadczy to o silnej motywacji stypendystów do utrzymania dobrych wyników i dbałości o status studenta.

**4. Styl życia i organizacja czasu: Imprezowanie**
Sposób spędzania czasu wolnego przez stypendystów wskazuje na efektywne zarządzanie czasem. Znacznie częściej wybierają oni model odpoczynku skumulowany w weekendy (35,6% vs 26,6%), co pozwala im na pełną koncentrację na obowiązkach akademickich w ciągu tygodnia roboczego.

**Podsumowanie:**
Profil stypendysty wyłaniający się z danych to profil studenta o wysokiej dyscyplinie pracy i umiejętności optymalizacji czasu wolnego. Choć średnie oceny obu grup są porównywalne, stypendyści wyróżniają się większym zaangażowaniem w naukę własną oraz bardziej ustrukturyzowanym stylem życia, co sprzyja stabilności ich wyników akademickich.


# Analiza korelacji

## Wpływ alkoholu na wyniki w nauce

```{r analiza korelacji pytanie 1, echo=FALSE, message=FALSE}

# 1. Przygotowanie danych
dane_kor <- dane %>%
  mutate(
    # Konwersja drinków na wartości numeryczne (środki przedziałów)
    drinks_num = case_when(
      drinks == "0" ~ 0,
      drinks == "1-3" ~ 2,
      drinks == "3-5" ~ 4,
      drinks == "5-8" ~ 6.5,
      drinks == "8+" ~ 10,
      TRUE ~ NA_real_
    ),
    # Hybrydowe GPA
    GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  ) %>%
  filter(!is.na(drinks_num), !is.na(GPA))

# 2. Obliczenie korelacji Spearmana
test_kor <- cor.test(dane_kor$drinks_num, dane_kor$GPA, method = "spearman", exact = FALSE)

# 3. Wizualizacja korelacji
ggplot(dane_kor, aes(x = drinks_num, y = GPA)) +
  geom_jitter(alpha = 0.4, color = "#2980b9", width = 0.3) +
  geom_smooth(method = "lm", color = "#c0392b", fill = "#e74c3c", alpha = 0.2) +
  labs(
    title = "Korelacja między spożyciem alkoholu a wynikami w nauce",
    subtitle = paste0("Współczynnik korelacji rho: ", round(test_kor$estimate, 3), 
                      " | p-value: ", format.pval(test_kor$p.value, digits = 3)),
    x = "Przeciętna liczba drinków podczas wyjścia",
    y = "Średnia ocen (GPA %)"
  ) +
  theme_minimal()

```

W celu sprawdzenia zależności między ilością spożywanego alkoholu a średnią ocen (GPA), przeprowadzono analizę korelacji rangowej Spearmana.

### Wyniki analizy
* **Współczynnik korelacji ($\rho$):** `-0.086`
* **Poziom istotności ($p$):** `0.087`

**Interpretacja statystyczna:**
Analiza wykazała bardzo słabą, ujemną tendencję, jednak zależność ta **nie osiągnęła przyjętego progu istotności statystycznej ($p < 0.05$)**. 

### Wnioski
1. **Brak istotności:** Ponieważ wartość $p$ (0.087) jest wyższa niż 0.05, nie mamy statystycznych podstaw, aby jednoznacznie stwierdzić, że konsumpcja alkoholu bezpośrednio obniża oceny w badanej populacji. Istnieje blisko 9% prawdopodobieństwa, że zaobserwowany trend jest jedynie wynikiem przypadku.
2. **Siła związku:** Współczynnik $\rho = -0.086$ wskazuje na korelację śladową. Sugeruje to, że w badanej grupie studenci mogą skutecznie oddzielać życie towarzyskie od wyników w nauce lub stosować mechanizmy kompensacyjne (np. intensywniejszą naukę w dni bez imprez).
3. **Złożoność zjawiska:** Wynik ten sugeruje, że alkohol może wpływać na wyniki jedynie pośrednio (np. poprzez absencję na zajęciach), a nie jako bezpośredni czynnik determinujący spadek GPA.

> **Podsumowanie:** Hipoteza o bezpośrednim, istotnym negatywnym wpływie alkoholu na średnią ocen **nie znalazła potwierdzenia** w zebranych danych.

# Model logitowy 

```{r model do pytania 6, echo=FALSE, message=FALSE, warning=FALSE}

dane_model <- dane %>%
  mutate(
    # Tworzymy zmienną binarną: Czy oblał cokolwiek? (1 = Tak, 0 = Nie)
    failed_any = ifelse(as.numeric(modules_failed) > 1, 1, 0),
    
    # Konwersja czynników na skale numeryczne
    party_num = case_when(
      partying == "0" ~ 0,
      partying == "1" ~ 1,
      partying == "Only weekends" ~ 1.5,
      partying == "2" ~ 2,
      partying == "3" ~ 3,
      partying == "4+" ~ 4,
      TRUE ~ NA_real_
    ),
    missed_num = case_when(
      classes_missed == "0" ~ 0,
      classes_missed == "1" ~ 1,
      classes_missed == "2" ~ 2,
      classes_missed == "3" ~ 3,
      classes_missed == "4+" ~ 4,
      TRUE ~ NA_real_
    )
  ) %>%
  filter(!is.na(failed_any), !is.na(party_num), !is.na(missed_num))

# 2. Budowa modelu regresji logistycznej
model_ryzyka <- glm(failed_any ~ party_num + missed_num, 
                    data = dane_model, 
                    family = binomial)

# 3. Wyciągnięcie Ilorazów Szans (Odds Ratios)
wyniki_modelu <- tidy(model_ryzyka, exponentiate = TRUE, conf.int = TRUE) %>%
  filter(term != "(Intercept)") # Usuwamy stałą dla czytelności wykresu

# 4. Wizualizacja: Forest Plot
ggplot(wyniki_modelu, aes(x = estimate, y = term)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2, color = "#2c3e50") +
  geom_point(size = 4, color = "#e74c3c") +
  scale_y_discrete(labels = c("party_num" = "Częstotliwość imprezowania", 
                              "missed_num" = "Opuszczanie zajęć")) +
  labs(
    title = "Iloraz Szans niezdania przedmiotu",
    subtitle = "Wartości > 1 oznaczają wzrost ryzyka. Czerwona linia (1.0) to brak wpływu.",
    x = "Ryzyko",
    y = ""
  ) +
  theme_minimal()

# 1. Przygotowanie czytelnej tabeli na podstawie wcześniej stworzonego modelu
tabela_wynikow <- wyniki_modelu %>%
  select(
    `Czynnik` = term,
    `Iloraz Szans (OR)` = estimate,
    `Błąd standardowy` = std.error,
    `Statystyka z` = statistic,
    `Wartość p (p-value)` = p.value,
    `Dolna granica (95%)` = conf.low,
    `Górna granica (95%)` = conf.high
  ) %>%
  mutate(
    # Mapowanie nazw na bardziej przyjazne
    Czynnik = case_when(
      Czynnik == "party_num" ~ "Częstotliwość imprezowania",
      Czynnik == "missed_num" ~ "Liczba opuszczonych zajęć",
      TRUE ~ Czynnik
    )
  )

# 2. Generowanie tabeli kable
kable(
  tabela_wynikow, 
  digits = 3, # Zaokrąglenie do 3 miejsc po przecinku
  caption = "Wyniki regresji logistycznej dla ryzyka niezdania przedmiotów",
  align = 'lcccccc' # Wyrównanie: lewo dla tekstu, środek dla liczb
)

```

```{r zrobienie danych do wykresu łokciowego, include=FALSE}
dane_analiza <- dane %>%
  mutate(
    # 1. Tworzymy punktację drinków
    drinks_num_score = case_when(
      drinks == "0" ~ 0,
      drinks == "1-3" ~ 2,
      drinks == "3-5" ~ 4,
      drinks == "5-8" ~ 6.5,
      drinks == "8+" ~ 10,
      TRUE ~ NA_real_
    ),
    
    # 2. Tworzymy punktację imprez
    party_num_score = case_when(
      partying == "0" ~ 0,
      partying == "1" ~ 1,
      partying == "Only weekends" ~ 1.5,
      partying == "2" ~ 2,
      partying == "3" ~ 3,
      partying == "4+" ~ 4,
      TRUE ~ NA_real_
    ),
    
    # 3. Tworzymy punktację nauki
    study_num_score = case_when(
      studying == "0" ~ 0,
      studying == "1-2" ~ 1.5, # poprawiłem zakres na 1-2 zgodnie z Twoim zbiorem
      studying == "3-5" ~ 4,
      studying == "5-8" ~ 6.5,
      studying == "8+" ~ 10,
      TRUE ~ NA_real_
    ),

    # 4. Konwersja allowance na wartość numeryczną
    allow_val = case_when(
      allowance == "R 0 - R 1000" ~ 500,
      allowance == "R 1001 - R 2000" ~ 1500,
      allowance == "R 2001 - R 3000" ~ 2500,
      allowance == "R 3001 - R 4000" ~ 3500,
      allowance == "R 4001- R 5000" ~ 4500,
      allowance == "R 5001 - R 6000" ~ 5500,
      allowance == "R 6001 - R 7000" ~ 6500,
      allowance == "R 7001 - R 8000" ~ 7500,
      allowance == "R 8001+" ~ 9000,
      TRUE ~ 0
    ),
    
    # 5. Grupowanie dochodu
    allow_group = ifelse(allow_val > 4000, "Wysoki budżet", "Niski budżet"),
    
    # 6. SKALA TOWARZYSKA (wykorzystujemy stworzone wyżej zmienne)
    # To rozwiązuje Twój błąd z recode!
    social_index = drinks_num_score + party_num_score,
    
    # 7. Wynik akademicki (hybrydowy)
    grade_final = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  )
```

```{r elbow_plot, echo=FALSE, message=FALSE, warning=FALSE}
# --- PRZYGOTOWANIE DANYCH ---
dane_do_klastrowania <- dane_analiza %>%
  select(drinks_num_score, party_num_score, study_num_score, grade_final) %>%
  na.omit() %>%
  scale()

# --- GENEROWANIE ŁADNIEJSZEGO WYKRESU ---
fviz_nbclust(dane_do_klastrowania, kmeans, method = "wss", linecolor = "#2c3e50") + # Zmiana koloru linii na granatowy
  geom_vline(xintercept = 3, linetype = "dashed", color = "#e74c3c", size = 1) +    # Czerwona linia przerywana
  geom_point(size = 3, color = "#2c3e50") +                                         # Większe kropki
  labs(title = "Optymalna liczba grup (Metoda Łokcia)",
       subtitle = "Wykres sugeruje podział studentów na 3 profilowane grupy (klastry)",
       x = "Liczba klastrów (k)",
       y = "Zmienność wewnątrz grupy (WSS)") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.title = element_text(size = 10)
  )
```

**Interpretacja:**
Metoda łokcia wskazuje na punkt "zagięcia" krzywej przy wartości **k = 3**. Oznacza to, że po wyodrębnieniu trzech grup, dalsze rozdrabnianie populacji nie przynosi istotnego wzrostu jakości dopasowania. Sugeruje to istnienie trzech głównych archetypów zachowań wśród badanych studentów.

# Wnioskowanie statystyczne

Sprawdzamy, czy środowisko akademika sprzyja gorszemu GPA w porównaniu do mieszkania prywatnego. Została zbadana różnica w wynikach w ostatnim roku dla studentów, którzy są teraz przynajmniej na 2 roku.

```{r wnioskowanie statystyczne akademiki vs GPA, echo=FALSE, warning=FALSE}
# Wykorzystujemy test Wilcoxona (odporny na brak rozkładu normalnego)
test_wynik <- wilcox.test(grade_last_y ~ accomodation, data = dane)

# Wizualizacja
ggplot(dane, aes(x = accomodation, y = grade_last_y, fill = accomodation)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Porównanie GPA względem miejsca zamieszkania",
       subtitle = paste("p-value =", round(test_wynik$p.value, 4))) +
  theme_minimal()
```



```{r pytanie 4 wykres test chi kwadrat, echo=FALSE, warning=FALSE}
# 1. Przygotowanie tabeli kontyngencji i testu
tab <- table(dane$parents_alcohol_approval, dane$drinks)
chi_test <- chisq.test(tab)

# 2. Wizualizacja: Heatmapa natężenia
dane %>%
  filter(!is.na(parents_alcohol_approval), !is.na(drinks)) %>%
  count(parents_alcohol_approval, drinks) %>%
  group_by(parents_alcohol_approval) %>%
  mutate(procent = n / sum(n) * 100) %>%
  ggplot(aes(x = drinks, y = parents_alcohol_approval, fill = procent)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#f7fbff", high = "#084594") +
  geom_text(aes(label = paste0(round(procent, 1), "%")), color = "black", size = 3) +
  labs(title = "Relacja: Aprobata rodziców vs Spożycie alkoholu",
       x = "Liczba drinków", y = "Aprobata rodziców", fill = "% w grupie") +
  theme_minimal()
```

```{r test chi kwadrat, echo=FALSE}
tidy(chi_test) %>%
  mutate(
    # 1. Formatowanie p-value (pogrubienie i czerwień dla p < 0.05)
    p_value_display = cell_spec(
      scales::pvalue(p.value, accuracy = 0.001),
      bold = ifelse(p.value < 0.05, TRUE, FALSE),
      color = ifelse(p.value < 0.05, "red", "black")
    ),
    # 2. Zaokrąglenie statystyki
    statistic = round(statistic, 2)
  ) %>%
  select(
    `Statystyka Chi²` = statistic, 
    `Stopnie swobody (df)` = parameter, 
    `Wartość p` = p_value_display,
    `Metoda` = method
  ) %>%
  kable(
    format = "html", 
    escape = FALSE, # Konieczne, aby kolory zadziałały
    align = "c",    # Wyśrodkowanie
    caption = "Wyniki testu niezależności Chi-kwadrat"
  ) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  row_spec(0, bold = TRUE, background = "#f2f2f2", color = "#2c3e50") %>% # Styl nagłówka
  column_spec(1, bold = TRUE)
```


```{r różnice między wydziałami, echo=FALSE}

dane_fac <- dane %>%
  mutate(drinks_num = case_when(
    drinks == "0" ~ 0,
    drinks == "1-3" ~ 2,
    drinks == "3-5" ~ 4,
    drinks == "5-8" ~ 6.5,
    drinks == "8+" ~ 10,
    TRUE ~ NA_real_
  )) %>%
  filter(!is.na(faculty), !is.na(drinks_num))

# 2. Test statystyczny Kruskala-Wallisa
kw_test <- kruskal.test(drinks_num ~ faculty, data = dane_fac)

# 3. Wykres średniego spożycia na wydziałach
dane_fac %>%
  group_by(faculty) %>%
  summarise(srednia_drinkow = mean(drinks_num), n = n()) %>%
  filter(n > 2) %>% # Odrzucamy wydziały z bardzo małą liczbą studentów
  ggplot(aes(x = reorder(faculty, srednia_drinkow), y = srednia_drinkow, fill = srednia_drinkow)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_viridis_c(option = "mako", direction = -1) +
  labs(title = "Średnie spożycie alkoholu na wydziałach",
       subtitle = paste("Test Kruskala-Wallisa p-value:", round(kw_test$p.value, 4)),
       x = "", y = "Średnia liczba drinków (indeks)") +
  theme_minimal() +
  theme(legend.position = "none")

```

```{r porównanie czy warto sie uczyc, echo=FALSE}
# 1. Przygotowanie danych i podział na grupy
dane_nauka <- dane %>%
  mutate(GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y)) %>%
  filter(!is.na(studying), !is.na(GPA)) %>%
  mutate(study_group = case_when(
    studying %in% c("0", "1-2", "3-5") ~ "Do 5h / tydz.",
    studying %in% c("5-8", "8+") ~ "Powyżej 5h / tydz.",
    TRUE ~ NA_character_
  )) %>%
  # Konwersja na faktor dla stabilności wykresu
  mutate(study_group = as.factor(study_group))

# 2. Wykres ggbetweenstats z testem odpornym
ggbetweenstats(
  data  = dane_nauka,
  x     = study_group,
  y     = GPA,
  type  = "robust", # Statystyka odporna na nierówne grupy i outliers
  tr    = 0.1,      # Średnia ucinana (10%)
  title = "Porównanie GPA względem czasu poświęconego na naukę",
  subtitle = "Podział na progu 5 godzin dodatkowej pracy tygodniowo",
  xlab  = "Intensywność nauki własnej",
  ylab  = "Średnia ocen (GPA %)",
  palette = "Set2", 
  package = "RColorBrewer",
  messages = FALSE
)

```

```{r czy nauka osłabia negatywny wpływ imprezowania, echo=FALSE}
# 1. Przygotowanie danych
dane_int <- dane %>%
  mutate(GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y)) %>%
  filter(!is.na(partying), !is.na(studying), !is.na(GPA)) %>%
  # Podział na grupy nauki (uproszczony dla czytelności wykresu)
  mutate(study_level = ifelse(studying %in% c("0", "1-2", "3-5"), "Mało nauki (<5h)", "Dużo nauki (>5h)")) %>%
  # Uproszczenie skali imprezowania
  mutate(party_level = case_when(
    partying == "0" ~ "Nigdy",
    partying %in% c("1", "Only weekends") ~ "Rzadko",
    partying %in% c("2", "3", "4+") ~ "Często",
    TRUE ~ NA_character_
  )) %>%
  # Porządkowanie poziomów na osi X
  mutate(party_level = factor(party_level, levels = c("Nigdy", "Rzadko", "Często")))

# 2. Obliczanie średnich dla punktów na wykresie
interakcja_summary <- dane_int %>%
  group_by(party_level, study_level) %>%
  summarise(mean_GPA = mean(GPA, na.rm = TRUE), .groups = 'drop')

# 3. Wykres interakcji (nowoczesna wersja ggplot2)
ggplot(interakcja_summary, aes(x = party_level, y = mean_GPA, color = study_level, group = study_level)) +
  geom_line(size = 1.2) +
  geom_point(size = 4) +
  scale_color_manual(values = c("Mało nauki (<5h)" = "#e74c3c", "Dużo nauki (>5h)" = "#2ecc71")) +
  labs(
    title = "Wykres interakcji: Nauka vs Imprezy",
    x = "Intensywność imprezowania",
    y = "Średnia ocen (GPA %)",
    color = "Poziom nauki:"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```


```{r wykres manova ancova anova (do obczajenia), echo=FALSE}
# 1. Przygotowanie danych (bez zmian)
dane_ancova <- dane %>%
  mutate(
    GPA = ifelse(is.na(grade_last_y), grade_12, grade_last_y),
    study_num = case_when(
      studying == "0" ~ 0,
      studying == "1-3" ~ 1.5,
      studying == "3-5" ~ 4,
      studying == "5-8" ~ 6.5,
      studying == "8+" ~ 10,
      TRUE ~ NA_real_
    ),
    faculty = as.factor(faculty) 
  ) %>%
  filter(!is.na(faculty), !is.na(GPA), !is.na(study_num)) %>%
  group_by(faculty) %>%
  filter(n() >= 5) %>%
  ungroup()

# 2. Model (bez zmian)
model_ancova <- lm(GPA ~ study_num + faculty, data = dane_ancova)

# --- ULEPSZONA TABELA 1: ISTOTNOŚĆ (ANOVA Typ III) ---
# Przygotowanie danych do tabeli
tabela_dane <- Anova(model_ancova, type = "III") %>%
  tidy() %>%
  # --- POPRAWKA: Usuwamy wiersze, które nie mają p-value (np. Residuals) ---
  filter(!is.na(p.value)) %>% 
  filter(term != "(Intercept)") %>%
  mutate(
    # Formatowanie p-value: Teraz bezpieczne, bo nie ma NA
    `Wartość p` = cell_spec(
      scales::pvalue(p.value, accuracy = 0.001), 
      bold = ifelse(p.value < 0.05, TRUE, FALSE),
      color = ifelse(p.value < 0.05, "red", "black")
    ),
    # Zaokrąglanie liczb dla czystości
    statistic = round(statistic, 2),
    sumsq = round(sumsq, 1)
  ) %>%
  rename(
    `Czynnik` = term, 
    `Suma kwadratów` = sumsq, 
    `df` = df,
    `Statystyka F` = statistic
  )

# --- WYKRES 1: WIZUALIZACJA WPŁYWU (bez zmian) ---
plot_model(model_ancova, 
           type = "est", 
           show.values = TRUE, 
           value.offset = .3,
           title = "Wpływ czynników na wynik GPA",
           axis.labels = NULL, 
           vline.color = "grey50",
           dot.size = 3.5,
           line.size = 1.2,
           colors = "Dark2") +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold"),
    axis.text.y = element_text(size = 10, face = "bold")
  ) +
  labs(
    subtitle = "Współczynniki regresji z 95% przedziałem ufności.",
    y = "Szacowana zmiana GPA (%)",
    x = ""
  )
```

```{r tabela ancova, echo=FALSE}
# Generowanie tabeli
tabela_dane %>%
  kable(
    format = "html", 
    escape = FALSE, # Ważne dla kolorowania
    align = "c",
    caption = "Tabela 1: Wyniki analizy kowariancji (ANCOVA)"
  ) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  row_spec(0, bold = TRUE, background = "#f2f2f2") 
```


