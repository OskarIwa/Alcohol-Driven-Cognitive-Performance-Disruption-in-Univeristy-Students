---
title: "Alcohol Driven Cognitive Performance Disruption in Univeristy Students"
author: "Oskar Iwaszkiewicz, BartÅ‚omiej Duda, Kajetan Bernat, Olga Dawidowicz"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme:
      bootswatch: cosmo  
    toc: true
    toc_float: true      
---

```{r pakiety, include=FALSE}
library(naniar)
library(dplyr)
library(tidyverse)
library(finalfit)
library(mice)
library(ggmice)
library(VIM)
library(ggplot2)
library(kableExtra)
library(knitr)
library(validate)
library(factoextra)
library(plotly)
library(shiny)
library(prettydoc)
library(flexdashboard)
library(ggalluvial)
```

# Wprowadzenie
## Cel badania
Celem niniejszego projektu jest zbadanie wielowymiarowych zaleÅ¼noÅ›ci miÄ™dzy spoÅ¼yciem alkoholu, towarzyszÄ…cym mu stylem Å¼ycia a wynikami w nauce (GPA) oraz funkcjonowaniem poznawczym studentÃ³w uniwersyteckich. Problem ten jest istotny ze wzglÄ™du na powszechnoÅ›Ä‡ kultury picia w Å›rodowisku akademickim i jej potencjalnie negatywny wpÅ‚yw na karierÄ™ edukacyjnÄ….
Analiza opiera siÄ™ na danych ankietowych obejmujÄ…cych zmienne demograficzne, ekonomiczne (stypendia, zakwaterowanie), spoÅ‚eczne (relacje z rodzicami) oraz behawioralne (czÄ™stotliwoÅ›Ä‡ imprezowania, absencja na zajÄ™ciach). W toku prac dane poddano czyszczeniu oraz imputacji, aby zapewniÄ‡ rzetelnoÅ›Ä‡ wnioskowania statystycznego.

## Pytania badawcze

W ramach analizy postawiono nastÄ™pujÄ…ce pytania badawcze, majÄ…ce na celu zgÅ‚Ä™bienie mechanizmÃ³w rzÄ…dzÄ…cych badanym zjawiskiem:

1. **BezpoÅ›redni wpÅ‚yw alkoholu na wyniki:** Czy istnieje istotna statystycznie, ujemna korelacja miÄ™dzy iloÅ›ciÄ… spoÅ¼ywanego alkoholu a Å›redniÄ… ocen (GPA)?
2. **Rola statusu ekonomicznego:** Czy wyÅ¼szy dochÃ³d rozporzÄ…dalny (`allowance`) stymuluje intensywniejsze Å¼ycie towarzyskie, poÅ›rednio wpÅ‚ywajÄ…c na obniÅ¼enie wynikÃ³w w nauce?
3. **Åšrodowisko zamieszkania a kultura studencka:** Czy rodzaj zakwaterowania (sektor prywatny/dom rodzinny vs. akademiki) rÃ³Å¼nicuje siÅ‚Ä™ zwiÄ…zku miÄ™dzy spoÅ¼yciem alkoholu a liczbÄ… opuszczonych zajÄ™Ä‡?
4. **PsychospoÅ‚eczne determinanty:** Czy jakoÅ›Ä‡ relacji z rodzicami oraz ich aprobata dla spoÅ¼ywania alkoholu stanowiÄ… istotne predyktory ryzykownych zachowaÅ„ studentÃ³w?
5. **Efekt kompensacji:** Czy zwiÄ™kszony nakÅ‚ad pracy wÅ‚asnej (dodatkowe godziny nauki w tygodniu) jest w stanie zniwelowaÄ‡ negatywny wpÅ‚yw "imprezowego stylu Å¼ycia" na Å›redniÄ… ocen?
6. W jakim stopniu "imprezowy styl Å¼ycia" zwiÄ™ksza ryzyko niezdania przedmiotÃ³w?
7. **RÃ³Å¼nice miÄ™dzypÅ‚ciowe (Gender Gap):** Czy pÅ‚eÄ‡ studenta rÃ³Å¼nicuje wzorce spoÅ¼ycia alkoholu oraz czy moderuje siÅ‚Ä™ zwiÄ…zku miÄ™dzy piciem a wynikami w nauce?


```{r data wrangling, include=FALSE}
dane <- read.csv("Stats survey.csv")
dane[dane == ""] <- NA
dane <- dane %>% select(-Timestamp)
dane <- dane %>% rename(sex = Your.Sex.,
                        grade_12 = Your.Matric..grade.12..Average..GPA..in...,
                        last_year = What.year.were.you.in.last.year..2023...,
                        faculty = What.faculty.does.your.degree.fall.under.,
                        grade_last_y = Your.2023.academic.year.average.GPA.in....Ignore.if.you.are.2024.1st.year.student.,
                        accomodation = Your.Accommodation.Status.Last.Year..2023.,
                        allowance = Monthly.Allowance.in.2023,
                        scholarship = Were.you.on.scholarship.bursary.in.2023.,
                        studying = Additional.amount.of.studying..in.hrs..per.week,
                        partying = How.often.do.you.go.out.partying.socialising.during.the.week..,
                        drinks = On.a.night.out..how.many.alcoholic.drinks.do.you.consume.,
                        classes_missed =  How.many.classes.do.you.miss.per.week.due.to.alcohol.reasons...i.e..being.hungover.or.too.tired..,
                        modules_failed = How.many.modules.have.you.failed.thus.far.into.your.studies.,
                        relationship = Are.you.currently.in.a.romantic.relationship.,
                        parents_alcohol_approval = Do.your.parents.approve.alcohol.consumption.,
                        relationship_w_parents =How.strong.is.your.relationship.with.your.parent.s.)

dane$sex <- ifelse(dane$sex == "Female", 0, ifelse(dane$sex == "Male", 1, dane$sex))
dane$sex <- factor(dane$sex, levels = c(0,1), labels = c("Kobieta", "MÄ™Å¼czyzna"))
dane$last_year <- ifelse(is.na(dane$last_year) & is.na(dane$grade_last_y), "12th class", dane$last_year)
dane$last_year <- factor(dane$last_year, levels = c("12th class", "1st Year", "2nd Year", "3rd Year", "4th Year", "Postgraduate"))
dane$faculty <- factor(dane$faculty, levels = unique(dane$faculty))
dane$accomodation <- ifelse(grepl("^Private.*", dane$accomodation), 1, ifelse(grepl("^Non.*", dane$accomodation), 0, dane$accomodation))
dane$accomodation <- factor(dane$accomodation, levels = c(0,1), labels = c("Nonprivate", "Private"))
dane$allowance <- factor(dane$allowance, levels = c("R 4001- R 5000", "R 5001 - R 6000", "R 6001 - R 7000", "R 7001 - R 8000", "R 8000+"))
dane$scholarship <- ifelse(dane$scholarship == "No", 0, ifelse(grepl("^Yes.*", dane$scholarship),1,dane$scholarship))
dane$scholarship <- factor(dane$scholarship, levels = c(0,1), labels = c("No", "Yes"))
dane$studying <- factor(dane$studying, levels = c("0", "1-3", "3-5", "5-8", "8+"))
dane$partying <- factor(dane$partying, levels = c("0", "1", "Only weekends", "2", "3", "4+"))
dane$drinks <- factor(dane$drinks, levels = c("0", "1-3", "3-5", "5-8", "8+"))
dane$classes_missed <- factor(dane$classes_missed, levels = c("0", "1", "2", "3",  "4+"))
dane$modules_failed <- factor(dane$modules_failed, levels = c("0", "1", "2", "3",  "4+"))
dane$relationship <- ifelse(dane$relationship == "No", 0, ifelse(dane$relationship == "Yes", 1, dane$relationship))
dane$relationship <- factor(dane$relationship, levels = c(0,1), labels = c("No", "Yes"))
dane$parents_alcohol_approval <- ifelse(dane$parents_alcohol_approval == "No", 0, ifelse(dane$parents_alcohol_approval == "Yes", 1, dane$parents_alcohol_approval))
dane$parents_alcohol_approval <- factor(dane$parents_alcohol_approval, levels = c(0,1), 
                                        labels = c("No", "Yes"))
dane$relationship_w_parents <- factor(dane$relationship_w_parents, levels = c("Distant", "Fair", "Close", "Very close"))
```

# Czyszczenie danych

W tym etapie surowe dane ankietowe zostaÅ‚y poddane standaryzacji i transformacji, aby umoÅ¼liwiÄ‡ ich dalszÄ… analizÄ™ statystycznÄ…. Wykonano nastÄ™pujÄ…ce operacje:

* **Selekcja i nazewnictwo:** UsuniÄ™to zbÄ™dne kolumny (np. znaczniki czasowe) oraz nadano zmiennym intuicyjne nazwy (np. `sex`, `grade_12`, `drinks`), zastÄ™pujÄ…c dÅ‚ugie pytania z kwestionariusza (Tabela 1).
* **Kodyfikacja zmiennych:**
    * Zmienne binarne (np. pÅ‚eÄ‡, stypendium) przekodowano na format **0-1**.
    * Zmienne opisowe (np. przedziaÅ‚y dochodÃ³w, liczba drinkÃ³w) zamieniono na **skalÄ™ porzÄ…dkowÄ…**, co pozwoli na zachowanie hierarchii danych w modelach korelacji.
* **Logika dla pierwszego roku:** Zidentyfikowano specyficznÄ… grupÄ™ studentÃ³w pierwszego roku ("12th class"). Ich braki danych w kolumnie ocen z poprzedniego roku akademickiego (`grade_last_y`) nie sÄ… bÅ‚Ä™dem, lecz wynikajÄ… ze struktury badania (brak historii studiowania). ZostaÅ‚o to uwzglÄ™dnione w procesie czyszczenia.
* **Walidacja danych:** ZostaÅ‚y rÃ³wnieÅ¼ sprawdzone ograniczenia, ktÃ³re musiaÅ‚y obejmowaÄ‡ zmienne i zostaÅ‚y pod tym kÄ…tem sprawdzone.
* **Duplikaty:** WÅ›rÃ³d obserwacji byÅ‚y rÃ³wnieÅ¼ duplikaty, jednak przez bardzo maÅ‚Ä… ich iloÅ›Ä‡ (2) zaÅ‚oÅ¼yliÅ›my, Å¼e istnieje moÅ¼liwoÅ›Ä‡ na zaistnienie takiej sytuacji, wiÄ™c nie zostaÅ‚y one usuniÄ™te.

```{r diagnostyka, include=FALSE}
#sprawdzenie sensu danych 
rules <- validator(
  Oceny_12_klasa = (grade_12 >= 0 & grade_12 <= 100) | is.na(grade_12),
  Oceny_zeszly_rok = (grade_last_y >= 0 & grade_last_y <= 100) | is.na(grade_last_y),
  Brak_oceny_12_klasa = if (last_year == "12th class") is.na(grade_last_y)
)
out <- confront(dane, rules)
summary(out)

#sprawdzenie NA w ostatniej zasadzie
dane %>% 
  filter(is.na(last_year))

#sprawdzenie duplikatÃ³w
sum(duplicated(dane))
dane %>%
  filter(duplicated(.))
dane %>% 
  filter(grade_12 == 85 & grade_last_y == 73)
dane %>% 
  filter(grade_12 == 71 & is.na(grade_last_y))

#usuniÄ™cie wierszy z brakami bez imputacji
dane <- dane %>% filter(!is.na(sex))
dane <- dane %>% filter(!is.na(faculty))
dane <- dane %>% filter(!is.na(last_year))

```


```{r tabela-zmiennych, echo=FALSE}

slownik <- data.frame(
  "Nazwa_Zmiennej" = c(
    "sex", "grade_12", "last_year", "faculty", "grade_last_y", 
    "accomodation", "allowance", "scholarship", "studying", 
    "partying", "drinks", "classes_missed", "modules_failed", 
    "relationship", "parents_alcohol_approval", "relationship_w_parents"
  ),
  "Opis_Pytania" = c(
    "PÅ‚eÄ‡ respondenta",
    "Åšrednia ocen z 12 klasy (GPA)",
    "Rok studiÃ³w w roku 2023",
    "Kierunek studiÃ³w",
    "Åšrednia ocen za rok akademicki 2023",
    "Status zakwaterowania (prywatne vs publiczne)",
    "MiesiÄ™czny budÅ¼et",
    "Czy student posiadaÅ‚ stypendium",
    "Dodatkowe godziny nauki tygodniowo",
    "CzÄ™stotliwoÅ›Ä‡ wychodzenia na imprezy",
    "Liczba drinkÃ³w spoÅ¼ywanych jednej nocy",
    "Liczba zajÄ™Ä‡ opuszczonych przez alkohol",
    "Liczba niezdanych przedmiotÃ³w",
    "Czy student jest w zwiÄ…zku",
    "Czy rodzice akceptujÄ… spoÅ¼ywanie alkoholu",
    "Relacja z rodzicami"
  )
)

# Generowanie Å‚adnej tabeli
kable(slownik, 
      col.names = c("Nazwa zmiennej", "Opis zmiennej"),
      caption = "Tabela 1: SÅ‚ownik zmiennych") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = F, 
                position = "left") %>%
  column_spec(1, bold = TRUE, color = "#2c3e50") %>% # WyrÃ³Å¼nienie nazw zmiennych
  column_spec(2, width = "30em") # Poszerzenie opisu dla czytelnoÅ›ci
```

# Analiza i diagnoza brakÃ³w danych

```{r wizualizacja brakÃ³w, echo=FALSE, warning=FALSE, fig.show='hold', out.width='50%', fig.height=6}
gg_miss_upset(dane, nsets = 5, nintersects = 10)


gg_miss_var(dane, show_pct = TRUE) + 
  labs(title = "Procentowy udziaÅ‚ brakÃ³w danych w zmiennych",
       y = "% BrakujÄ…cych wartoÅ›ci",
       x = "Zmienne") +
  theme_minimal()

```

Przed przystÄ…pieniem do imputacji (uzupeÅ‚niania) danych, przeprowadzono wizualnÄ… inspekcjÄ™ brakujÄ…cych wartoÅ›ci przy uÅ¼yciu pakietÃ³w `naniar` i `ggmice`. PozwoliÅ‚o to na podjÄ™cie kluczowych decyzji:

1. **Eliminacja rekordÃ³w:** UsuniÄ™to obserwacje posiadajÄ…ce braki w kluczowych zmiennych strukturalnych: `sex` (pÅ‚eÄ‡), `faculty` (wydziaÅ‚) oraz `last_year` (rok studiÃ³w). Zmienne te definiujÄ… profil studenta i sÄ… trudne do wiarygodnego, sztucznego odtworzenia.
2. **Identyfikacja mechanizmu brakÃ³w:** Potwierdzono, Å¼e czÄ™Å›Ä‡ brakÃ³w ma charakter strukturalny (wspomniani studenci pierwszego roku), co wyklucza prostÄ… imputacjÄ™ Å›redniÄ… dla caÅ‚ej populacji.

```{r imputacja danych, warning=FALSE, include=FALSE}
dane_imp <- kNN(dane, variable = c("grade_last_y", "grade_12", "accomodation", "allowance", "scholarship", "studying", "classes_missed", "modules_failed"), k = 5)

dane$grade_last_y <- as.numeric(ifelse(dane$last_year != "12th class" & is.na(dane$grade_last_y), dane_imp$grade_last_y, dane$grade_last_y))

dane <- dane %>%
  mutate(
    allowance = coalesce(allowance, dane_imp$allowance),
    scholarship = coalesce(scholarship, dane_imp$scholarship),
    accomodation = coalesce(accomodation, dane_imp$accomodation),
    grade_12 = coalesce(grade_12, dane_imp$grade_12),
    studying = coalesce(studying, dane_imp$studying),
    classes_missed = coalesce(classes_missed, dane_imp$classes_missed),
    modules_failed = coalesce(modules_failed, dane_imp$modules_failed)
  )

```

# Imputacja danych

PozostaÅ‚e braki danych (w zmiennych takich jak `allowance`, `scholarship` czy `grades`) uzupeÅ‚niono, wykorzystujÄ…c algorytm **k-Nearest Neighbors (kNN)**. Metoda ta polega na znalezieniu dla kaÅ¼dej niepeÅ‚nej obserwacji grupy najbardziej podobnych do niej studentÃ³w ("sÄ…siadÃ³w") i uzupeÅ‚nieniu braku na podstawie ich danych.

**DobÃ³r parametru $k=5$:**

Zdecydowano siÄ™ na ustawienie parametru liczby sÄ…siadÃ³w na $k=5$. Jest to optymalny kompromis:

* WartoÅ›Ä‡ ta jest wystarczajÄ…co duÅ¼a, aby zminimalizowaÄ‡ wpÅ‚yw pojedynczych wartoÅ›ci odstajÄ…cych (szumu w danych).
* JednoczeÅ›nie jest wystarczajÄ…co maÅ‚a, aby zachowaÄ‡ lokalnÄ… strukturÄ™ danych i nie doprowadziÄ‡ do nadmiernego "wygÅ‚adzenia" (uÅ›rednienia) specyficznych cech studentÃ³w.

Dla zmiennej `grade_last_y` zastosowano podejÅ›cie hybrydowe: imputacja zostaÅ‚a przeprowadzona, a nastÄ™pnie skorygowana logicznie dla studentÃ³w pierwszego roku, aby nie przypisywaÄ‡ im sztucznych ocen z okresu, gdy nie studiowali.

```{r wizualizacja imputacji, echo=FALSE, fig.height=6, fig.show='hold', warning=FALSE, out.width='50%'}
#jakoÅ›Ä‡ imputcji

ggplot(dane_imp, aes(x = allowance, y = grade_12, color = allowance_imp)) +
  geom_jitter(alpha = 0.6, width = 0.2, size = 2.5) +
  scale_color_manual(values = c("skyblue3", "firebrick1"), 
                     labels = c("Oryginalne", "Imputowane")) +
  labs(title = "Weryfikacja imputacji: MiesiÄ™czny budÅ¼et (allowance)",
       subtitle = "RozkÅ‚ad ocen wzglÄ™dem budÅ¼etu z zaznaczeniem wartoÅ›ci uzupeÅ‚nionych",
       x = "Kategoria budÅ¼etu (allowance)",
       y = "Åšrednia ocen (grade_12)",
       color = "Status danych") +
  theme_minimal()

ggplot(dane_imp, aes(x = accomodation, y = grade_12, color = accomodation_imp)) +
  geom_jitter(alpha = 0.6, width = 0.15, size = 2.5) +
  scale_color_manual(values = c("skyblue3", "firebrick1"), 
                     labels = c("Oryginalne", "Imputowane")) +
  labs(title = "Weryfikacja imputacji: Zakwaterowanie (accomodation)",
       subtitle = "RozkÅ‚ad ocen wzglÄ™dem rodzaju zakwaterowania",
       x = "Rodzaj zakwaterowania",
       y = "Åšrednia ocen (grade_12)",
       color = "Status danych") +
  theme_minimal()

```

## Weryfikacja jakoÅ›ci imputacji
W celu potwierdzenia poprawnoÅ›ci dziaÅ‚ania algorytmu wygenerowano wykresy typu stripplot dla zmiennych `allowance` oraz `accommodation`. ZdecydowaliÅ›my siÄ™ akurat na te zmienne ze wzglÄ™du na to, Å¼e tylko one majÄ… braki na poziomie co najmniej 5% (oprÃ³cz brakÃ³w strukturalnych w `grade_12`).

Wybrano zestawienie tych kategorii ze zmiennÄ… `grade_12`, aby sprawdziÄ‡, czy wartoÅ›ci uzupeÅ‚nione (zaznaczone na czerwono) naturalnie wpisujÄ… siÄ™ w rozkÅ‚ad danych oryginalnych. Brak wyraÅºnych skupisk punktÃ³w imputowanych poza chmurÄ… danych zaobserwowanych potwierdza, Å¼e proces uzupeÅ‚niania nie wprowadziÅ‚ znieksztaÅ‚ceÅ„ do struktury zbioru.

# Wizualizacja danych

```{r wizualizacja danych, eval=FALSE, include=FALSE}
dane %>% 
  ggplot(aes(x=grade_12)) +
  geom_density(aes(fill=sex) , alpha = .25) +
  ggtitle("Oceny w 12 klasie") +
  xlab("Oceny") +
  ylab("CzÄ™stoÅ›Ä‡")

dane_clust <- dane %>%
  mutate(
    party_num = recode(partying,
                       "0"=0,"1"=1,"2"=2,"3"=3,"4+"=4,"Only weekends"=1.5),
    drinks_num = recode(drinks,
                        "0"=0,"1-3"=2,"3-5"=4,"5-8"=6,"8+"=9),
    grade = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  ) %>%
  select(studying, party_num, drinks_num, classes_missed, modules_failed, grade) %>%
  na.omit()

ui <- fluidPage(

  titlePanel("ğŸ”¥ Interaktywna Mapa ArchetypÃ³w StudentÃ³w"),

  sidebarLayout(
    sidebarPanel(
      sliderInput("clusters", "Liczba archetypÃ³w:", 
                  min = 2, max = 6, value = 4, step = 1),
      helpText("Archetypy mogÄ… byÄ‡ np.: Imprezowicz, Robot, PrzeciÄ™tniak, Ryzykant itd.")
    ),

    mainPanel(
      plotlyOutput("pcaPlot"),
      br(),
      uiOutput("archetypeDescriptions")
    )
  )
)

server <- function(input, output, session){

  # --- PCA ---
  pca <- prcomp(scale(dane_clust))

  clustered <- reactive({
    set.seed(123)
    km <- kmeans(scale(dane_clust), centers = input$clusters)
    df <- data.frame(pca$x[,1:2], cluster = factor(km$cluster))
    df
  })

  # --- OPIS ARCHETYPÃ“W ---
  output$archetypeDescriptions <- renderUI({

    desc <- c(
      "1" = "<b>Archetyp 1:</b> Imprezowicz â€“ duÅ¼o imprezuje, duÅ¼o pije, nisko siÄ™ uczy.",
      "2" = "<b>Archetyp 2:</b> Robot â€“ duÅ¼o siÄ™ uczy, maÅ‚o imprezuje, dobre oceny.",
      "3" = "<b>Archetyp 3:</b> PrzeciÄ™tniak â€“ Å›rednio we wszystkim.",
      "4" = "<b>Archetyp 4:</b> Ryzykant â€“ duÅ¼o imprezuje, ale oceny jeszcze trzymajÄ… siÄ™ Å›rednio.",
      "5" = "<b>Archetyp 5:</b> SamozagÅ‚ada 
      ,3000
      â€“ duÅ¼o imprez + maÅ‚o nauki + fatalne oceny.",
      "6" = "<b>Archetyp 6:</b> Ukryty Robot â€“ maÅ‚o imprezuje, oceny wysokie mimo maÅ‚ego nakÅ‚adu pracy."
    )

    HTML(paste(desc[1:input$clusters], collapse = "<br><br>"))
  })

  # --- PCA plot ---
  output$pcaPlot <- renderPlotly({

    df <- clustered()

    p <- ggplot(df, aes(PC1, PC2, color = cluster)) +
      geom_point(size = 4, alpha = 0.8) +
      scale_color_brewer(palette = "Set1") +
      labs(title = "Mapa ArchetypÃ³w StudentÃ³w (PCA + clustering)",
           x = "PC1", y = "PC2", color = "Archetyp") +
      theme_minimal()

    ggplotly(p)
  })
}

shinyApp(ui, server)

```

```{r zrobienie danych, include=FALSE}
dane_analiza <- dane %>%
  mutate(
    # Konwersja allowance na wartoÅ›Ä‡ numerycznÄ… (Å›rodek przedziaÅ‚u)
    allow_val = case_when(
      allowance == "R 0 - R 1000" ~ 500,
      allowance == "R 1001 - R 2000" ~ 1500,
      allowance == "R 2001 - R 3000" ~ 2500,
      allowance == "R 3001 - R 4000" ~ 3500,
      allowance == "R 4001- R 5000" ~ 4500,
      allowance == "R 5001 - R 6000" ~ 5500,
      allowance == "R 6001 - R 7000" ~ 6500,
      allowance == "R 7001 - R 8000" ~ 7500,
      allowance == "R 8001+" ~ 9000,
      TRUE ~ 0
    ),
    # Grupowanie dochodu dla lepszej czytelnoÅ›ci (Niski vs Wysoki)
    allow_group = ifelse(allow_val > 4000, "Wysoki budÅ¼et", "Niski budÅ¼et"),
    # Skala towarzyska (Partying + Drinks)
    social_index = recode(partying, "0"=0, "1"=1, "2"=2, "3"=3, "4+"=4, "Only weekends"=1.5) +
                   recode(drinks, "0"=0, "1-3"=2, "3-5"=4, "5-8"=6, "8+"=9),
    # Wynik akademicki (hybrydowy)
    grade_final = ifelse(is.na(grade_last_y), grade_12, grade_last_y)
  )
```

## WpÅ‚yw statusu ekonomicznego na styl Å¼ycia i wyniki

W tej sekcji postaraliÅ›my siÄ™ odpowiedzieÄ‡ na pytanie badawcze **czy wyÅ¼szy dochÃ³d rozporzÄ…dzalny stymuluje intensywniejsze Å¼ycie towarzyskie?**

```{r pytanie 2, echo=FALSE}
ggplot(dane_analiza, aes(x = social_index, y = grade_final)) +
  # Generowanie chmur gÄ™stoÅ›ci
  geom_density_2d_filled(alpha = 0.8) +
  facet_wrap(~allow_group) + 
  
  # Ustawienie kolorÃ³w i etykiet (uproszczone: tylko Niska i Wysoka)
  scale_fill_viridis_d(
    option = "plasma",
    labels = c("Niska", "", "", "", "", "", "", "", "","", "Wysoka")
  ) +
  
  labs(
    title = "Koncentracja studentÃ³w: Nauka vs Zabawa",
    subtitle = "ZaleÅ¼noÅ›Ä‡ miÄ™dzy budÅ¼etem a stylem Å¼ycia.",
    x = "Indeks Towarzyski",
    y = "Wynik Akademicki (GPA %)",
    fill = "GÄ™stoÅ›Ä‡ wystÄ™powania:"
  ) +
  
  theme_minimal() +
  theme(
    # Przeniesienie legendy na dÃ³Å‚
    legend.position = "bottom",
    legend.box = "horizontal",
    # Pogrubienie tytuÅ‚u i dodanie mu miejsca
    legend.title = element_text(face = "bold", size = 10),
    # KLUCZOWE: Dodanie marginesu na dole caÅ‚ego wykresu, Å¼eby legenda siÄ™ zmieÅ›ciÅ‚a
    plot.margin = margin(t = 10, r = 10, b = 25, l = 10),
    # OdstÄ™py miÄ™dzy panelami
    panel.spacing = unit(2, "lines"),
    strip.text = element_text(face = "bold")
  ) +
  
  # Konfiguracja wyglÄ…du paska legendy
  guides(fill = guide_legend(
    nrow = 1, 
    # WydÅ‚uÅ¼enie paska (keywidth), Å¼eby byÅ‚o go lepiej widaÄ‡
    keywidth = unit(1.3, "cm"), 
    keyheight = unit(0.4, "cm"),
    # Ustawienie tytuÅ‚u NAD paskiem (to rozwiÄ…zuje problem widocznoÅ›ci napisu)
    title.position = "top", 
    title.hjust = 0.5,
    label.position = "bottom"
  ))
```

### Metodologia i wskaÅºniki
Aby umoÅ¼liwiÄ‡ obiektywne porÃ³wnanie grup, wprowadzono dwa parametry analityczne:

* **PodziaÅ‚ budÅ¼etu:** PrÃ³bÄ™ badawczÄ… podzielono na dwa segmenty wzglÄ™dem miesiÄ™cznego kieszonkowego:
    * **NiÅ¼szy budÅ¼et:** $\le 5000$ R.
    * **WyÅ¼szy budÅ¼et:** $> 5000$ R.
* **Indeks Towarzyski:** Stworzono zagregowany wskaÅºnik (skala 0â€“13 pkt), bÄ™dÄ…cy sumÄ… punktÃ³w za:
    * *CzÄ™stotliwoÅ›Ä‡ imprezowania* (`partying`): 0â€“4 pkt (w tym wartoÅ›Ä‡ 1.5 dla "Only weekends").
    * *IloÅ›Ä‡ spoÅ¼ywanego alkoholu* (`drinks`): 0â€“9 pkt.
    * WskaÅºnik ten obrazuje **caÅ‚kowitÄ… intensywnoÅ›Ä‡ stylu Å¼ycia** studenta.

### Interpretacja mapy gÄ™stoÅ›ci
Wizualizacja wykorzystuje metodÄ™ estymacji gÄ™stoÅ›ci jÄ…drowej (**2D Kernel Density**). Skala kolorystyczna wskazuje na stopieÅ„ koncentracji obserwacji w danej przestrzeni.

### Kluczowe wnioski
1.  **PieniÄ…dze jako stymulant:** W grupie z **wyÅ¼szym budÅ¼etem** â€oÅ›rodek ciÄ™Å¼koÅ›ciâ€ (Å¼Ã³Å‚ty obszar) wyraÅºnie przesuwa siÄ™ w prawÄ… stronÄ™ osi X. Potwierdza to, Å¼e wiÄ™ksze zasoby finansowe uÅ‚atwiajÄ… dostÄ™p do pÅ‚atnych rozrywek i sprzyjajÄ… **czÄ™stszej konsumpcji alkoholu**.
2.  **ZwiÄ™kszone ryzyko akademickie:** ChoÄ‡ w obu grupach najwyÅ¼sze oceny korelujÄ… z niskÄ… intensywnoÅ›ciÄ… imprezowania, grupa zasobna wykazuje znacznie wiÄ™ksze **rozproszone w stronÄ™ wysokiej intensywnoÅ›ci towarzyskiej**. Sugeruje to, Å¼e nadmiar Å›rodkÃ³w sprzyja przedkÅ‚adaniu zabawy nad obowiÄ…zki.
3.  **Dyscyplina niÅ¼szych dochodÃ³w:** Studenci z niÅ¼szym budÅ¼etem wykazujÄ… silniejszÄ… koncentracjÄ™ w obszarze **umiarkowanego Å¼ycia towarzyskiego**, co przekÅ‚ada siÄ™ na statystycznie stabilniejsze i bardziej przewidywalne wyniki w nauce.

> **Podsumowanie:** WyÅ¼szy status ekonomiczny dziaÅ‚a jako **katalizator Å¼ycia towarzyskiego**. ZwiÄ™kszajÄ…c dostÄ™pnoÅ›Ä‡ kosztownych rozrywek, staje siÄ™ on poÅ›rednim czynnikiem ryzyka dla wynikÃ³w akademickich poprzez wyraÅºnÄ… zmianÄ™ priorytetÃ³w czasowych studenta.

## RÃ³Å¼nice miÄ™dzypÅ‚ciowe

```{r wykres pytanie 7, echo=FALSE, warning=FALSE}
# 1. DANE
dane_plot <- dane %>%
  filter(!is.na(drinks), !is.na(grade_last_y), !is.na(sex)) %>%
  mutate(drinks = factor(drinks, levels = c("0", "1-3", "3-5", "5-8", "8+")))

# 2. AGREGACJA
srednie_df <- dane_plot %>%
  group_by(sex, drinks) %>%
  summarise(srednia_ocena = mean(grade_last_y), .groups = "drop")

# 3. KOLORYSTYKA "MODERN TECH"
my_colors <- c("Kobieta" = "#FF2D55",  # Apple Pink / Coral
               "MÄ™Å¼czyzna" = "#007AFF") # Apple Blue

# 4. WYKRES BAZOWY
p <- ggplot() +
  
  # A. SKRZYPCE (TÅO)
  geom_violin(data = dane_plot, 
              aes(x = drinks, y = grade_last_y, color = sex, fill = sex),
              alpha = 0.1,            # Bardzo delikatne tÅ‚o, Å¼eby nie przytÅ‚aczaÅ‚o
              trim = TRUE,            
              size = 0.3,             # Cieniutki kontur
              position = position_dodge(width = 0.7)) +
  
  # B. LINIE TRENDU
  geom_line(data = srednie_df, 
            aes(x = drinks, y = srednia_ocena, group = sex, color = sex),
            size = 1.2, 
            position = position_dodge(width = 0.7)) +
  
  # C. PUNKTY (NOÅšNIK INFORMACJI)
  # Tylko tutaj definiujemy 'text'
  geom_point(data = srednie_df, 
             aes(x = drinks, y = srednia_ocena, color = sex,
                 text = paste0("<b>", sex, "</b>",
                               "<br>Liczba drinkÃ³w: ", drinks,
                               "<br>Åšrednia ocena: ", round(srednia_ocena, 1))),
             size = 3.5, shape = 18, # Nieco wiÄ™ksze punkty dla czytelnoÅ›ci
             position = position_dodge(width = 0.7)) +
  
  # D. ESTETYKA
  scale_color_manual(values = my_colors) +
  scale_fill_manual(values = my_colors) +
  scale_y_continuous(limits = c(30, 100)) + 
  labs(x = "Liczba drinkÃ³w podczas wyjÅ›cia", y = "Åšrednia ocen (GPA)") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(), # Pionowe linie sÄ… zbÄ™dne przy kategoriach
    legend.position = "none"
  )

# 5. FINALNY PLOTLY + FIX DYMKÃ“W (NUCLEAR OPTION)
final_tech <- ggplotly(p, tooltip = "text") %>%
  layout(
    font = list(family = "Arial, sans-serif", size = 12, color = "#333333"),
    title = list(text = "<b>Czy pÅ‚eÄ‡ moderuje wpÅ‚yw alkoholu na wyniki?</b>", 
                 y = 0.96, x = 0.05, xanchor = "left", font = list(size = 18)),
    legend = list(
      orientation = "h", xanchor = "center", x = 0.5, y = -0.15,
      title = list(text = "<b>PÅ‚eÄ‡: </b>"),
      itemclick = "toggleothers",
      itemdoubleclick = "toggle"
    ),
    margin = list(t = 70, b = 80, l = 60, r = 20),
    hovermode = "closest"
  ) %>%
  config(displayModeBar = FALSE)

for (i in seq_along(final_tech$x$data)) {
  # Sprawdzamy, czy dana warstwa to punkty (mode zawiera 'markers')
  # JeÅ›li nie (czyli to linie lub skrzypce), ustawiamy hoverinfo na 'skip'
  if (!grepl("markers", final_tech$x$data[[i]]$mode)) {
    final_tech$x$data[[i]]$hoverinfo <- "skip"
  }
}

final_tech
```


```{r analiza opisowa}

```



